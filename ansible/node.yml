#!/usr/bin/env ansible-playbook
---
#==============================================================#
# Init a local yum repo (to accelerate further provision)
# Note that it may take large amount of time to complete first
# run, after that, run `make cache` to copy all repo pkgs to
# your own host machine to accelerate next-time repo-construction
#==============================================================#
- name: Init Repo
  become: yes
  hosts: meta
  tags: repo
  gather_facts: true
  vars:
    proxy_env: {}                     # add http/https/all proxy settings here
    force_download:   false           # force download even cache exists
    build_essential:  true            # download gcc, g++, rpmbuild, etc...
    cloud_native:     true            # download kubectl kubeadm helm docker, etc..
    # additional_package_list: []     # additional packages to be installed  roles:

  roles:
    - role: repo


#==============================================================#
# Provision all nodes
# create some user, tune some paremeters, setup dns, ntp, etc...
#==============================================================#
- name: Init Node
  become: yes
  hosts: all
  tags: node
  gather_facts: true
  vars:
    # node packages
    proxy_env: {}
    cloud_native:     true                # install docker and kubernetes tools
    build_essential:  false               # download gcc, g++, rpmbuild, etc...
    # additional_package_list: []         # additional packages to be installed  roles:

    # node setup
    default_dns_server: 10.10.10.10
    default_ntp_server: 10.10.10.10
    default_timezone: 'Asia/Shanghai'

    # node tune
    node_disable_swap: true
    node_disable_thp: true
    node_disable_firewall: true
    node_enable_watchdog: true
    node_disk_prefetch: false
    node_disable_numa: false

    # node consul server
    consul_server: [10.10.10.10]          # list your consul server address here
    node_exporter_port: 9100              # node exporter port & metrics url path
    node_exporter_metric_path: /metrics

  roles:
    - role: node                          # provision nodes
    - role: cloud
      when: cloud_native                  # prepare docker & k8s environment

...

