#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   initdb-monitor.yml
# Mtime     :   2020-06-01
# Desc      :   init monitor system
# Path      :   playbooks/initdb-monitor.yml
# Author    :   Vonng(fengruohang@outlook.com)
#==============================================================#


- name: Init Monitoring System
  gather_facts: false
  any_errors_fatal: true
  become: yes
  become_method: sudo
  vars:
    force: false

  # works on dynamic built group 'replica'
  hosts: all
  tasks:
    ################################################################
    # PHASE 1: [check] replica instance precondition
    ################################################################
    - name: Check monitor facts
      tags: [always, check_monitor]
      block:
        # override these variable with -e
        - set_fact:
            mon_user={{ mon_user | default('dbuser_monitor') }}
            mon_pass={{ mon_pass | default('dbuser_monitor') }}
            biz_db={{ biz_db | default(cluster) }}

        - name: Check replica node connectivity
          action: ping
        - name: Check replica postgres is installed with version {{ version }}
          shell: "[[ $(/usr/pgsql/bin/pg_ctl --version) == 'pg_ctl (PostgreSQL) {{ version }}'* ]]"


    ################################################################
    # PHASE 1: copy pg_exporter.yaml config file
    ################################################################
    # send pg_exporter.yaml
    - name: Config pg_exporter
      tags: [copy_pg_exporter_config]
      block:
        - name: Create /etc/pg_exporter conf dir
          file: path=/etc/pg_exporter state=directory owner=prometheus group=postgres mode=0775
        - name: Config pg_exporter with /etc/pg_exporter/pg_exporter.yaml
          copy: src=templates/pg_exporter/pg_exporter.yaml dest=/etc/pg_exporter/pg_exporter.yaml owner=postgres group=postgres mode=0644

    ################################################################
    # PHASE 1: [config] pg_exporter
    ################################################################
    - name: Config pg_exporter
      tags: [config_pg_exporter]
      block:
        - name: Config pg_exporter opts
          template: src=templates/pg_exporter/pg_exporter.default dest=/etc/default/pg_exporter owner=postgres group=postgres mode=0600
        - name: Config pg_exporter service unit
          copy: src=templates/pg_exporter/pg_exporter.service dest=/usr/lib/systemd/system/pg_exporter.service owner=postgres group=postgres mode=0644


    ################################################################
    # PHASE 2: [config] pgbouncer_exporter
    ################################################################
    - name: Config pgbouncer_exporter
      tags: [config_pgbouncer_exporter]
      block:
        - name: Config pgbouncer_exporter opts
          template: src=templates/pg_exporter/pgbouncer_exporter.default dest=/etc/default/pgbouncer_exporter owner=postgres group=postgres mode=0600
        - name: Config pgbouncer_exporter service unit
          copy: src=templates/pg_exporter/pgbouncer_exporter.service dest=/usr/lib/systemd/system/pgbouncer_exporter.service owner=postgres group=postgres mode=0644


    ################################################################
    # PHASE 2: [launch] pg_exporter and pgbouncer_exporter
    ################################################################
    - name: Launch monitor service
      tags: [launch_pg_exporter]
      systemd: name={{ item }} state=restarted enabled=yes daemon_reload=yes
      with_items:
        - pg_exporter
        - pgbouncer_exporter


    ################################################################
    # PHASE 1: [register] services
    ################################################################
    - name: Register pg_exporter service
      tags: [register_service]
      template:
        src: templates/consul/{{ item }}.json
        dest: /etc/consul.d/{{ item }}.json
        owner: consul
        group: postgres
        mode: 0660
      with_items:
        - node-meta
        - srv-postgres
        - srv-pgbouncer
        - srv-patroni
        - srv-cluster
        - srv-node-exporter
        - srv-pg-exporter
        - srv-pgbouncer-exporter

    ################################################################
    # PHASE 1: [register] services
    ################################################################
    - name: Restart consul
      tags: [restart_consul]
      systemd: name=consul state=restarted enabled=yes daemon_reload=yes

