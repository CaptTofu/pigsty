---

#==============================================================#
# Stage 1: Precheck                                            #
#==============================================================#
- name: Pigsty repo download precheck
  tags: pigsty_repo_precheck
  block:
    # Pre Condition: make sure cache dir /www/pigsty/boot exists
    - name: Create pigsty repo directory
      file: path=/www/pigsty state=directory mode=0755

    # Condition Check: whether normal rpm cache already exists
    - name: Check pigsty repo cache exists
      stat: path=/www/pigsty/repo_complete
      register: repo_cache


#==============================================================#
# Stage 2: Download yum packages
#==============================================================#
- name: Download local repo packages
  when: not repo_cache.stat.exists or (force_download is defined and force_download|bool)
  tags: pigsty_package_download
  block:
    # install official yum repo
    - name: Install centos yum repos
      environment: "{{ proxy_env | default({}) }}"
      yum: name=epel-release,centos-release-scl,centos-release-scl-rh

    # copy additional yum repo
    - name: Install additional yum repos
      copy: src={{ item }}.repo dest=/etc/yum.repos.d/{{ item }}.repo mode=0644
      with_items: [nginx, haproxy, postgres, grafana, prometheus, docker, k8s ]

    - name: Download packages from yum repo
      environment: "{{ proxy_env | default({}) }}"
      yum:
        download_only: yes
        download_dir: /www/pigsty
        name: "{{ package_list }}"

    - name: Download packages from web
      environment: "{{ proxy_env | default({}) }}"
      get_url: dest=/www/pigsty/{{ item.name }} url={{ item.url }}
      with_items:
        - {name: pg_exporter-0.2.0-1.el7.x86_64.rpm, url: "https://github.com/Vonng/pg_exporter/releases/download/v0.2.0/pg_exporter-0.2.0-1.el7.x86_64.rpm"}
        - {name: patroni-1.6.5-1.rhel7.x86_64.rpm, url: "https://github.com/cybertec-postgresql/patroni-packaging/releases/download/1.6.5-1/patroni-1.6.5-1.rhel7.x86_64.rpm"}

    # pg_exporter, patroni important
    - name: Download cloud native packages
      when: cloud_native is defined and cloud_native|bool
      environment: "{{ proxy_env | default({}) }}"
      yum:
        download_only: yes
        download_dir: /www/pigsty
        name: "{{ cloud_package_list }}"

    # gcc, g++, rpmbuild, etc...
    - name: Download build essential packages
      when: build_essential is defined and build_essential|bool
      environment: "{{ proxy_env | default({}) }}"
      yum:
        download_only: yes
        download_dir: /www/pigsty
        name: "{{ build_package_list }}"

    # create repo
    - name: Create yum repo index
      command: createrepo /www/pigsty

    # set complete flag
    - name: Build local yum repo complete
      copy: content=ok dest=/www/pigsty/repo_complete


...
