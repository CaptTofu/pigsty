---
- name: Setup meta nginx
  tags: nginx_setup
  block:

    #==============================================================#
    # Stage 1: Setup nginx
    #==============================================================#
    - name: Copy nginx conf
      copy: src={{ item }}.conf dest=/etc/nginx/conf.d/{{ item }}.conf
      with_items:
        - default
        - consul
        - grafana
        - prometheus
        - alertmanager
        - haproxy
        - pgadmin

    - name: Restart nginx service
      systemd: name=nginx state=restarted enabled=yes daemon_reload=yes

    #==============================================================#
    # Stage 2: Setup nginx exporter
    #==============================================================#
    - name: Config nginx_exporter opts
      copy:
        src: nginx_exporter.default
        dest: /etc/default/nginx_exporter

    - name: Restart nginx service
      systemd: name=nginx_exporter state=restarted enabled=yes daemon_reload=yes


    #==============================================================#
    # Stage 3: Register nginx and nginx_exporter to dcs
    #==============================================================#
    - name: Copy consul services definition
      copy:
        src: srv-{{ item }}.json
        dest: /etc/consul.d/srv-{{ item }}.json
        mode: 0660
        owner: consul
        group: consul
      with_items:
        - nginx
        - nginx-exporter

    - name: Reload consul service
      systemd: name=consul state=reloaded enabled=yes daemon_reload=yes
...


