---

#==============================================================#
# Stage 1: Precheck                                            #
#==============================================================#
- name: Pigsty repo boostrap precheck
  tags: pigsty_repo_precheck
  block:
    # Pre Condition: make sure cache dir /www/pigsty/boot exists
    - name: Create pigsty repo directory
      file: path=/www/pigsty/boot state=directory mode=0755

    # Condition Check: whether normal rpm cache already exists
    - name: Check pigsty repo cache exists
      stat: path=/www/pigsty/repo_complete
      register: repo_cache

    # Condition Check: whether bootstrap cache already exists
    - name: Check pigsty boot cache exists
      stat: path=/www/pigsty/boot/boot_complete
      register: boot_cache



#==============================================================#
# Stage 2: Download bootstrap packages if not exists
#==============================================================#
- name: Pigsty repo boostrap packages download
  when: not boot_cache.stat.exists
  tags: pigsty_repo_download
  block:
    # install official yum repo
    - name: Install centos yum repos
      environment: "{{ proxy_env | default({}) }}"
      yum: name=epel-release,centos-release-scl,centos-release-scl-rh

    # copy nginx yum repo
    - name: Install nginx yum repo
      copy: src=nginx.repo dest=/etc/yum.repos.d/nginx.repo mode=0644

    # download minimal package to build a local yum repo
    - name: Download bootstrap packages
      environment: "{{ proxy_env | default({}) }}"
      yum:
        download_only: yes
        download_dir: /www/pigsty/boot
        name: epel-release,createrepo,wget,yum-utils,nginx

    # set bootstrap packages download complete flag
    - name: Download packages complete
      copy: content=ok dest=/www/pigsty/boot/boot_complete



#==============================================================#
# Stage 3: Install bootstrap packages
#==============================================================#
# install bootstrap packages from cache dir /www/pigsty/boot
- name: Install bootstrap packages
  tags: [pigsty_repo_install]
  shell: cd /www/pigsty/boot && yum localinstall -q -y *.rpm



#==============================================================#
# Stage 4: Setup nginx server
#==============================================================#
- name: Setup nginx server
  tags: pigsty_nginx_setup
  block:
    - name: Copy nginx conf
      copy: src=default.conf dest=/etc/nginx/conf.d/default.conf

    - name: Copy nginx content
      copy: src={{ item }} dest=/www/{{ item }}
      with_items: [index.html, pigsty.repo]

    - name: Launch nginx service
      systemd: name=nginx state=restarted enabled=yes daemon_reload=yes

    - name: Waits nginx online
      wait_for: host=localhost port=80 state=started


...