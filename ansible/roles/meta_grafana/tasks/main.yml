---

#==============================================================#
# Stage 1: Setup grafana service
#==============================================================#
- name: Setup Grafana
  tags: grafana_setup
  block:
    - name: Copy grafana configs
      copy: src=grafana.ini dest=/etc/grafana/grafana.ini owner=grafana group=grafana

    # provision via directly copied sqlite database
    - name: Provision grafana via grafana.db
      copy:
        src: grafana.db
        dest: /var/lib/grafana/grafana.db
        owner: grafana
        group: grafana
        mode: 0660

    # provision via pre-configured yaml/json files
    - name: Provision grafana datasources
      when: grafana_provision_datasources
      copy: src=datasources/ dest=/etc/grafana/provisioning/datasources/ owner=grafana group=grafana mode=0640

    - name: Provision grafana dashboards
      when: grafana_provision_dashboards
      copy: src=dashboards/ dest=/etc/grafana/provisioning/dashboards/ owner=root group=grafana mode=0640

    - name: Launch grafana service
      systemd: name=grafana-server state=restarted enabled=yes daemon_reload=yes

    - name: Wait grafana online
      wait_for: host=localhost port=3000 state=started

    - name: Copy grafana consul services definition
      copy:
        src: srv-{{ item }}.json
        dest: /etc/consul.d/srv-{{ item }}.json
        mode: 0660
        owner: consul
        group: consul
      with_items:
        - grafana

    - name: Reload consul service
      systemd: name=consul state=reloaded enabled=yes




#==============================================================#
# Stage 2: Setup grafana service
#==============================================================#
- name: Setup grafana plugins
  when: grafana_provision_plugins
  tags: meta_grafana_plugin_setup
  block:
    - name: Check grafana cache exists
      stat: path=/www/pigsty/grafana/grafana.tar.gz
      register: grafana_plugins_cache

    # extract cache pacakge and install
    - name: Provision grafana plugins
      when: grafana_plugins_cache.stat.exists
      shell: |
        mkdir -p /var/lib/grafana && rm -rf /var/lib/grafana/*
        tar -xf /www/pigsty/grafana/grafana.tar.gz -C /var/lib/grafana --strip-components=3
        chown -R grafana:grafana /var/lib/grafana

    - name: Download grafana plugins if not exists
      when: grafana_force_download_plugins or (not grafana_plugins_cache.stat.exists)
      shell: |
        grafana-cli plugins install simpod-json-datasource
        # grafana-cli plugins install ryantxu-ajax-panel
        # grafana-cli plugins install grafana-piechart-panel
        # grafana-cli plugins install jdbranham-diagram-panel
        # grafana-cli plugins install aidanmountford-html-panel
        # grafana-cli plugins install camptocamp-prometheus-alertmanager-datasource
        # grafana-cli plugins install alexandra-trackmap-panel
        # grafana-cli plugins install snuids-radar-panel
        # grafana-cli plugins install digrich-bubblechart-panel

        # tar plugins to cache dir
        mkdir -p /www/pigsty/grafana
        tar -zcf /www/pigsty/grafana/grafana.tar.gz /var/lib/grafana

    - name: Restart grafana service
      systemd: name=grafana-server state=restarted enabled=yes daemon_reload=yes

...


