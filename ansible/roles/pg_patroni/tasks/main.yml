#!/usr/bin/ansible-playbook
---

#==============================================================#
# Stage 1: Patroni install
#==============================================================#
- name: Install patroni from local yum
  tags: patroni_install
  yum: name=patroni


#==============================================================#
# Stage 2: Clean up patroni
#==============================================================#
- name: Cleanup Patroni
  tags: patroni_cleanup
  block:
    - name: Disable patroni services
      ignore_errors: true
      systemd: name=patroni state=stopped enabled=no

    - name: Remove consul metadata
      ignore_errors: true
      command: consul kv delete -recurse /pg/{{ cluster }}


#==============================================================#
# Stage 3: Setup patroni service
#==============================================================#
- name: Setup Patroni
  tags: patroni_setup
  block:
    - name: Copy shell scripts
      template: src={{ item }} dest=/pg/bin/{{ item }} owner=postgres group=postgres mode=0700
      with_items:
        - callback.sh
        - register.sh

    - name: Copy patroni config
      template:
        src: "patroni.yml"
        dest: "/pg/conf/{{ instance_name }}.yml"
        owner: postgres
        group: postgres
        mode: 0755

    - name: Make patroni config link
      file:
        src: /pg/conf/{{ instance_name }}.yml
        dest: /pg/bin/patroni.yml
        owner: postgres
        group: postgres
        state: link

    - name: Copy patroni systemd service
      copy:
        src: patroni.service
        dest: /usr/lib/systemd/system/patroni.service
        owner: root
        group: root
        mode: 0644

    - name: Launch primary patroni first
      when: role == 'primary'
      systemd:
        name: patroni
        state: restarted
        enabled: yes
        daemon_reload: yes


    - name: Launch patroni replica service
      when: role != 'primary'
      systemd:
        name: patroni
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Waits patroni launch
      wait_for: host={{ inventory_hostname }} port=8008 state=started timeout=30
...