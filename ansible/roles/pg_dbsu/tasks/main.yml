---

#==============================================================#
# Stage 1: Create user                                         #
#==============================================================#
- name: Create dbsu postgres
  tags: dbsu_create
  block:
    - name: Create os group postgres
      group: name=postgres gid=256

    - name: Create os user postgres
      user: name=postgres group=postgres home=/home/postgres generate_ssh_key=yes


#==============================================================#
# Stage 2: Exchange SSH Key                                    #
#==============================================================#
- name: Exchange ssh key for dbsu postgres
  tags: dbsu_key_exchange
  block:
    - name: Add ssh config
      shell: |
        if ! grep -q "StrictHostKeyChecking" /home/postgres/.ssh/config; then
            echo "StrictHostKeyChecking=no" >> /home/postgres/.ssh/config
        fi
        exit 0

    - name: Fetch all public key
      shell: cat /home/postgres/.ssh/id_rsa.pub
      register: ssh_keys

    - name: Check all public key
      debug: msg="{{ ssh_keys.stdout }}"

    # for all hosts, copy their postgres ssh public key to each other
    - name: Copy ssh key to authorized hosts
      authorized_key: user=postgres key="{{ item[0] }}"
      delegate_to: "{{ item[1] }}"
      with_nested:
        - "{{ ssh_keys.stdout }}"
        - "{{ play_hosts }}"

    - name: Fetch all public key
      shell: cat /home/postgres/.ssh/id_rsa.pub
      register: ssh_keys



#==============================================================#
# Stage 3: Setup Sudo                                          #
#==============================================================#
- name: Setup dbsu sudo
  tags: dbsu_sudo_setup
  block:
    - name: Allow postgres systemctl nopass sudo
      copy:
        content: "postgres ALL=(ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/postgres
        mode: 0440


#==============================================================#
# Stage 4: Setup PAM Limit                                          #
#==============================================================#
- name: Setup dbsu pam limit
  tags: dbsu_limit_setup
  copy:
    src: postgres.conf
    dest: /etc/security/limits.d/postgres.conf
    mode: 0640

...