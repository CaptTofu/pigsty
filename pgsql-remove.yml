#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   pgsql-remove.yml
# Mtime     :   2020-05-12
# Mtime     :   2022-11-05
# Desc      :   remove pgsql from hosts
# Path      :   pgsql-remove.yml
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#


#==============================================================#
# Playbook : Remove pgsql Cluster/Instance                     #
#==============================================================#
#  Remove cluster `pg-test`
#     pgsql-remove.yml -l pg-test
#
#  Remove instance (10.10.10.13) among cluster `pg-test`
#     pgsql-remove.yml -l 10.10.10.13
#
#  Remove postgres data along with pg_packages
#     pgsql-remove.yml -e rm_pgdata=true -e rm_pgpkgs=true
#
#  Register cluster/instance to infrastructure
#     pgsql-remove.yml --tags=register  # prometheus, grafana, nginx
#     pgsql-remove.yml --tags=service   # haproxy, vip
#     pgsql-remove.yml --tags=monitor   # pg_exporter, pgbouncer_exporter, node_exporter, promtail
#     pgsql-remove.yml --tags=pgbouncer # pgbouncer
#     pgsql-remove.yml --tags=postgres  # postgres
#     pgsql-remove.yml --tags=haproxy   # remove haproxy
#==============================================================#
- name: PGSQL Remove
  become: yes
  hosts: all
  tags: pg-remove
  gather_facts: no
  ignore_errors: yes
  vars:

    rm_pgdata: true         # remove postgres data? true by default
    rm_pgpkgs: false        # uninstall pg_packages? false by default

  roles:
    - role: pg_remove
      when: not pg_safeguard|bool

...