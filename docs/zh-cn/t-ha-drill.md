# 数据库高可用场景演练

您可以通过高可用场景演练，来加强对集群高可用能力的信心。

以下列出了24种典型的高可用故障场景，分为主库故障，从库故障，DCS故障三类，每类8个具体场景。

所有演练均假设**高可用自动切换模式**已启用，其中，Patroni应当正确处理主库故障与从库故障。

|  编号  | 案例名称                                                     |       自动模式       | 手动切换 |
| :----: | :----------------------------------------------------------- | :------------------: | :------: |
| ***A** | **主库故障**                                                 |                      |          |
|   1A   | 主库节点宕机                                                 |   **自动Failover**   | 人工切换 |
|   2A   | 主库Postgres进程异常Kill（`kill -9`）                        |   **自动Failover**   | 人工重启 |
|   3A   | 主库Postgres进程手工关停 （`pg_ctl`）                        |   **自动Failover**   | 人工重启 |
|   4A   | 主库Patroni进程异常Kill（`kill -9`）                         |   **自动Failover**   |  无影响  |
|   5A   | 主库DCS Agent不可用（`systemctl stop consul`）               |   **自动Failover**   |  无影响  |
|   6A   | 主库负载打满，假死                                           |       Depends        |  需观察  |
|   7A   | 主库网络抖动                                                 | **超时自动Failover** |  需观察  |
|   8A   | 误删主库数据目录                                             |   **自动Failover**   | 手工切换 |
| ***B** | **从库故障（1/n , n>1）**                                    |                      |          |
|   1B   | 从库节点宕机                                                 |        无影响        |  无影响  |
|   2B   | 从库Postgres进程异常Kill（`kill -9`）                        |        无影响        |  无影响  |
|   3B   | 从库Postgres进程手工关停 （`pg_ctl`）                        |        无影响        |  无影响  |
|   4B   | 从库Patroni进程异常Kill（`kill -9`）                         |        无影响        |  无影响  |
|   5B   | 从库DCS Agent不可用（`systemctl stop consul`）               |        无影响        |  无影响  |
|   6B   | 从库负载打满，假死                                           |       Depends        | Depends  |
|   7B   | 从库网络抖动                                                 |        无影响        |  无影响  |
|   8B   | 误提升一个从库（`pg_ctl promte`）                            |     **自动恢复**     | **脑裂** |
| ***C** | **DCS故障**                                                  |                      |          |
|   1C   | DCS Server完全不可用（多数节点不可用）                       |     **亟需介入**     |  无影响  |
|   2C   | DCS通主库，不通从库（1主1从）                                |        无影响        |  无影响  |
|   3C   | DCS通主库，不通从库（1主n从，n>1）                           |        无影响        |  无影响  |
|   4C   | DCS通从库，不通主库（1主1从）                                |        无影响        |  无影响  |
|   5C   | DCS通从库，不通主库（1主n从，n>1）                           |   **自动Failover**   |  无影响  |
|   6C   | DCS网络抖动：同时中断，<br />主库从库同时恢复，或主库先恢复  |        无影响        |  无影响  |
|   7C   | DCS网络抖动：同时中断，<br />从库先恢复，主库后恢复（1主1从） |       无影响*        |  无影响  |
|   8C   | DCS网络抖动：同时中断，<br />从库先恢复，主库后恢复（1主n从，n>1） | 超过TTL自动Failover  |  无影响  |

-----------------------

## 主库故障演练

### 1A-主库节点宕机



### 2A-主库Postgres进程异常Kill


### 3A-主库Postgres进程手工关停


### 4A-主库Patroni进程异常Kill


### 5A-主库DCS Agent不可用


### 6A-主库负载打满，假死


### 7A-主库网络抖动


### 8A-误删主库数据目录

-----------------------

## 从库故障演练

### 1B-从库节点宕机


### 2B-从库Postgres进程异常Kill


### 3B-从库Postgres进程手工关停


### 4B-从库Patroni进程异常Kill


### 5B-从库DCS Agent不可用


### 6B-从库负载打满，假死


### 7B-从库网络抖动


### 8B-误提升一个从库


-----------------------

## DCS故障演练

### 1C-DCS Server完全不可用（多数节点不可用）


### 2C-DCS通主库，不通从库（1主1从）


### 3C-DCS通主库，不通从库（1主n从，n>1）


### 4C-DCS通从库，不通主库（1主1从）


### 5C-DCS通从库，不通主库（1主n从，n>1）


### 6C-DCS网络抖动：同时中断，主库从库同时恢复，或主库先恢复


### 7C-DCS网络抖动：同时中断，从库先恢复，主库后恢复（1主1从）


### 8C-DCS网络抖动：同时中断，从库先恢复，主库后恢复（1主n从，n>1）

