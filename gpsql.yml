#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   gpsql.yml
# Ctime     :   2022-01-19
# Mtime     :   2022-02-28
# Desc      :   init gpsql
# Path      :   gpsql.yml
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#

#---------------------------------------------------------------
# How to create greenplum/matrixdb cluster ?
#  1. gpsql.yml
#  2. visit http://matrix.pigsty and installation with UI
#  3. gpsql-post.yml
#---------------------------------------------------------------


#---------------------------------------------------------------
- name: Check Inventory
  hosts: all
  gather_facts: no
  tags: preflight
  tasks:
    - name: Check greenplum inventory
      assert:
        that:
          - nodename is defined    # you have to explict set hostname for gp members
          - gp_role is defined and (gp_role == 'master' or gp_role == 'segment')
          - gp_role == 'master' or (gp_role == 'segment' and pg_instances is defined and pg_instances|length > 0)

#---------------------------------------------------------------
# init greenplum/matrixdb master cluster
#---------------------------------------------------------------
- name: GP Master Init
  become: yes
  hosts: all
  gather_facts: no
  tags: gp-master-init
  vars:

    pg_dbsu: mxadmin              # matrixdb dbsu
    pg_dbsu_uid: 1226             # matrixdb dbsu uid & gid
    pg_dbsu_home: /home/mxadmin   # matrixdb dbsu homedir
    patroni_enabled: false        # do not pull up normal postgres with patroni
    pgbouncer_enabled: true       # enable pgbouncer for greenplum master
    pg_provision: false           # provision postgres template & database & user
    haproxy_enabled: false        # disable haproxy monitor on greenplum
    pg_exporter_params: 'host=127.0.0.1&sslmode=disable'  # use 127.0.0.1 as local monitor host
    pg_exporter_exclude_database: 'template0,template1,postgres,matrixmgr' # optional, comma separated list of database that WILL NOT be monitored when auto-discovery enabled
    pg_packages: [ 'matrixdb postgresql${pg_version}* pgbouncer pg_exporter node_exporter consul pgbadger pg_activity' ]
    pg_extensions: [ ]

  roles:
    - role: postgres
      when: gp_role == 'master'


#---------------------------------------------------------------
# register greenplum master databases to grafana
#---------------------------------------------------------------
- name: GP Master Register
  become: yes
  hosts: all
  gather_facts: no
  tags: gp-master-grafana
  tasks:
    - include_tasks: roles/pg_register/tasks/grafana.yml
      when: gp_role == 'master'
      ignore_errors: true

#---------------------------------------------------------------
# init greenplum/matrixdb segments cluster
#---------------------------------------------------------------
- name: GP Segment Init
  become: yes
  hosts: all
  gather_facts: no
  tags: gp-segment-init
  vars:

    pg_preflight_skip: true             # skip preflight check on segments (since pg_instances are used instead)
    pg_dbsu: mxadmin                    # matrixdb dbsu
    pg_dbsu_uid: 1226                   # matrixdb dbsu uid & gid
    pg_dbsu_home: /home/mxadmin         # matrixdb dbsu homedir
    node_name_exchange: true            # exchange node names among cluster
    patroni_enabled: false              # do not pull up normal postgres with patroni
    pgbouncer_enabled: false            # enable pgbouncer for greenplum master
    pg_provision: false                 # provision postgres template & database & user
    pg_packages: [ 'matrixdb postgresql${pg_version}* pgbouncer pg_exporter node_exporter consul pgbadger pg_activity' ]
    pg_extensions: [ ]

  roles:
    - role: postgres
      when: gp_role == 'segment'



#---------------------------------------------------------------
# init greenplum/matrixdb segments monitor
#---------------------------------------------------------------
- name: GP Segment Monitor
  become: yes
  hosts: all
  gather_facts: no
  tags: gp-segment-monitor
  vars:
    pg_dbsu: mxadmin                          # matrixdb dbsu
    haproxy_enabled: false                    # disable haproxy monitor on greenplum
    pgbouncer_exporter_enabled: false         # pgbouncer not enabled
    pg_exporter_config: pg_exporter_basic.yml # use basic config to avoid segment server crash
    pg_exporter_params: 'host=/tmp&options=-c%20gp_role%3Dutility&sslmode=disable'  # use gp_role = utility to connect to segments
    pg_exporter_exclude_database: 'template0,template1,postgres,matrixmgr' # optional, comma separated list of database that WILL NOT be monitored when auto-discovery enabled
  roles:

    # prepare pg_exporter for multiple greenplum segments instances
    - role: pg_exporters
      when: gp_role == 'segment'


#---------------------------------------------------------------
# master provision
#---------------------------------------------------------------
- name: GP Master Provisioning
  become: yes
  hosts: all
  gather_facts: no
  tags: gp-segment-provision
  roles: [ ]

