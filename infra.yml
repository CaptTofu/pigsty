#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra.yml
# Ctime     :   2020-04-13
# Mtime     :   2021-01-11
# Desc      :   init infrastructure on meta nodes
# Path      :   infra.yml
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#

#==============================================================#
# Playbook : Init Meta Node
#==============================================================#
#  Init infra on meta nodes (special group 'meta')
#     infra.yml
#
#  Setup environment on meta node (dir, ssh, pgpass, env)
#     infra.yml -t environ
#
#  Setup local yum repo
#     infra.yml -t repo
#
#  Setup prometheus
#     infra.yml -t prometheus
#
#  Setup grafana
#     infra.yml -t grafana
#
#  Setup nginx
#     infra.yml -t nginx
#
#  Setup cmdb on meta nodes
#     infra.yml -t pgsql
#
#  Sync dashboards baseline to grafana
#     infra.yml -t dashboard
#
#  Upgrade grafana with postgres as primary database
#     infra.yml -t grafana -e grafana_database=postgres
#     ssh meta rm -rf /etc/grafana/provisioning/dashboards/pigsty.yml
#
#==============================================================#

#---------------------------------------------------------------
- name: Infra Init
  become: yes
  hosts: meta
  gather_facts: no
  tags: infra
  roles:

    - role: environ         # init postgres pgbouncer patroni
      tags: environ

    - role: repo            # init local yum repo on meta node
      tags: repo
      when: repo_enabled|bool

    - role: node            # init meta node
      tags: node

    - role: node_exporter   # init node exporter
      tags: node_exporter

    - role: consul          # init dcs:consul (servers)
      tags: dcs

    - role: ca              # init ca-infrastructure
      tags: ca

    - role: nameserver      # init dns nameserver
      tags: nameserver

    - role: nginx           # init nginx
      tags: nginx

    - role: prometheus      # init prometheus
      tags: prometheus

    - role: grafana         # init grafana
      tags: grafana


#---------------------------------------------------------------
- name: Pgsql Init          # init cmdb on meta nodes
  become: yes
  hosts: meta
  gather_facts: no
  tags: pgsql
  roles:

    - role: postgres        # init postgres pgbouncer patroni
      tags: postgres

    - role: pg_exporter     # init monitor exporters
      tags: pg_exporter

    - role: service         # init service , lb , vip
      tags: service

    - role: register        # register cluster/instance to infra
      tags: register

#---------------------------------------------------------------
...
