#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra.yml
# Desc      :   init pigsty infrastructure on infra nodes
# Ctime     :   2021-01-19
# Mtime     :   2022-11-29
# Path      :   infra.yml
# License   :   AGPLv3
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#

#---------------------------------------------------------------
# create CA (if not exists on files/pki/ca)
#---------------------------------------------------------------
- name: CA
  become: yes
  hosts: localhost
  gather_facts: no
  tags: ca
  roles: [{ role: ca }]

#---------------------------------------------------------------
# deploy pigsty infra on infra nodes
#---------------------------------------------------------------
- name: INFRA
  become: yes
  hosts: infra
  gather_facts: no
  tags: infra       # infra playbook only works on infra nodes
  roles:
    - { role: node_id        ,tags: node-id    }  # generate node & pgsql identity
    - { role: infra_cert     ,tags: cert       }  # issue cert for infra
    - { role: environ        ,tags: environ    }  # setup admin environment vars
    - { role: repo           ,tags: repo       }  # create local yum repo
    - { role: nginx          ,tags: nginx      }  # launch nginx portal
    - { role: node           ,tags: node       }  # prepare node for pigsty
    - { role: haproxy        ,tags: haproxy    }  # init haproxy if enabled
    - { role: docker         ,tags: docker     }  # init docker if enabled
    - { role: nameserver     ,tags: nameserver }  # setup dnsmasq
    - { role: prometheus     ,tags: prometheus }  # setup prometheus, alertmanager, pushgateway, blackbox_exporter
    - { role: grafana        ,tags: grafana    }  # setup grafana
    - { role: loki           ,tags: loki       }  # setup loki
    - { role: infra_register ,tags: register   }  # register infra services
    - { role: node_exporter  ,tags: monitor    }  # init node exporter if enabled
    - { role: promtail       ,tags: promtail   }  # init promtail if enabled
    - { role: node_register  ,tags: register   }  # register node to infra
...