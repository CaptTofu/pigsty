#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra.yml
# Ctime     :   2020-04-13
# Mtime     :   2021-07-06
# Desc      :   init infrastructure on meta nodes
# Path      :   infra.yml
# Copyright (C) 2018-2021 Ruohang Feng (rh@vonng.com)
#==============================================================#

#---------------------------------------------------------------
- name: Infra Init      # init infra on meta node
  become: yes
  hosts: meta
  gather_facts: no
  tags: infra
  roles:

    - role: environ     # init postgres pgbouncer patroni
      tags: environ

    - role: repo        # init local yum repo on meta node
      tags: repo

    - role: node        # init meta node
      tags: node

    - role: consul      # init dcs:consul (servers)
      tags: [ dcs , consul ]

    - role: ca          # init certification infrastructure
      tags: ca

    - role: nameserver  # init dns nameserver
      tags: nameserver

    - role: nginx       # init nginx
      tags: nginx

    - role: prometheus  # init prometheus
      tags: prometheus

    - role: grafana     # init grafana
      tags: grafana

#---------------------------------------------------------------
  tasks:                # init dashboards
    - name: Dashboards Init
      tags: dashboard
      synchronize:
        src: app/pgsql/dashboards/pgsql
        dest: /etc/pigsty/dashboards/pgsql

#---------------------------------------------------------------
- name: Pgsql Init      # init pgsql-cmdb on meta nodes
  become: yes
  hosts: meta
  gather_facts: no
  tags: pgsql
  roles:

    - role: postgres   # init postgres pgbouncer patroni
      tags: postgres

    - role: monitor    # init monitor exporters
      tags: monitor

    - role: service    # init service , lb , vip
      tags: service

    - role: register   # register cluster/instance to infra
      tags: register

#---------------------------------------------------------------
...
