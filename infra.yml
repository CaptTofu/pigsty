#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra.yml
# Ctime     :   2021-01-19
# Mtime     :   2022-11-04
# Desc      :   init infrastructure on meta nodes
# Path      :   infra.yml
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#

#---------------------------------------------------------------
# setup node & pgsql identity
#---------------------------------------------------------------
- name: Identity
  hosts: all
  gather_facts: no
  tags: id
  roles:

    - role: node_id     # get node identity (always)
      tags: node-id

#---------------------------------------------------------------
# setup admin node with ca and environment (usually localhost)
#---------------------------------------------------------------
- name: ADMIN BOOT
  become: yes
  hosts: localhost
  gather_facts: no
  tags: admin-boot
  roles:

    - role: ca          # init ca-infra & dist to nodes
      tags: ca

#---------------------------------------------------------------
# bootstrap infra nodes with local yum repo
#---------------------------------------------------------------
- name: INFRA BOOT
  become: yes
  hosts: meta
  gather_facts: no
  tags: infra-boot
  roles:

    - role: infra_cert  # setup infrastructure certificates
      tags: infra_cert

    - role: environ     # setup environment on meta nodes
      tags: environ

    - role: repo        # setup local yum repo on meta nodes
      tags: repo        # you can disable repo on extra meta nodes with nginx_enabled: false
      when: nginx_enabled|bool

    # NODE
    - role: node        # init meta node itself
      tags: [ node , node-init ]

    - role: ca          # init ca-infra & dist to nodes
      tags: ca

    - role: docker      # init docker if enabled
      tags: docker
      when: docker_enabled|bool

    - role: etcd        # init etcd if enabled
      tags: [ dcs, etcd ]

    # INFRA
    - role: nameserver  # init dns nameserver
      tags: nameserver
      # when: nameserver_enabled|bool

    - role: nginx       # init nginx
      tags: nginx
      # when: nginx_enabled|bool

    - role: prometheus  # init prometheus
      tags: prometheus
      # when: prometheus_enabled|bool

    - role: grafana     # init grafana
      tags: grafana
      # when: grafana_enabled|bool

    - role: loki        # init loki
      tags: loki
      # when: loki_enabled|bool

    - role: infra_register  # register infra targets
      tags: infra-register

    # init & register node exporter
    - role: node_exporter
      tags: node-exporter
      when: node_exporter_enabled|bool

    # init & register promtail log agent
    - role: promtail
      tags: promtail
      when: promtail_enabled|bool

    # register node monitor target to prometheus
    - role: node_register
      tags: node-register

...