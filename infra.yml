#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra.yml
# Ctime     :   2020-04-13
# Mtime     :   2021-07-06
# Desc      :   init infrastructure on meta nodes
# Path      :   infra.yml
# Copyright (C) 2018-2021 Ruohang Feng (rh@vonng.com)
#==============================================================#


#==============================================================#
# init pigsty meta node environment (dir,ssh,pgpass,env)
#==============================================================#
- name: Init Environment
  become: yes
  hosts: meta
  gather_facts: no
  tags: environ
  roles:
    - environ

#==============================================================#
# init local yum repo on meta node to accelerate
#==============================================================#
- name: Init Repo
  become: yes
  hosts: meta
  gather_facts: no
  tags: repo
  roles:
    - repo

#==============================================================#
# init meta nodes just as common nodes
#==============================================================#
- name: Init Node
  become: yes
  hosts: meta
  gather_facts: no
  tags: node
  roles:
    - node

#==============================================================#
# init infra service on meta node
#==============================================================#
- name: Init Infra
  become: yes
  hosts: meta
  gather_facts: no
  tags: infra
  roles:
    - role: ca
      tags: ca

    - role: nameserver
      tags: nameserver

    - role: nginx
      tags: nginx

    - role: prometheus
      tags: prometheus

    - role: grafana
      tags: grafana

#==============================================================#
# launch consul or etcd SERVER on meta nodes
#==============================================================#
# if external dcs_servers are specified, only DCS Client will be installed
- name: Init dcs
  become: yes
  hosts: meta
  gather_facts: no
  tags: [infra, dcs ]
  roles:
    - role: consul
      tags: [ consul ]


#==============================================================#
# init `pg-meta` postgres cluster on meta nodes (used as default database)
#==============================================================#
- name: Init MetaDB
  become: yes
  hosts: meta
  gather_facts: no
  tags: [ pgsql ]
  roles:
    - role: postgres                        # init postgres
      tags: [ postgres ]

    - role: monitor                         # init monitor system
      tags: [ monitor ]

    - role: service                         # init haproxy
      tags: [ service ]

    - role: register                        # register cmdb
      tags: [ register ]


#==============================================================#
# init core application : pgsql (monitoring dashboards)
#==============================================================#
- name: Init App
  hosts: meta
  gather_facts: no
  tags: app
  tasks:
    - name: Sync application resources
      synchronize: src=app/ dest=~/app

    - name: Check pgsql install script
      stat: path=~/app/pgsql/install
      register: check_result

    - name: Install pgsql application
      when: not check_result.failed
      become: yes
      command: bash {{ check_result.stat.path }}


...
