#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   pgsql.yml
# Desc      :   init postgres cluster/instance
# Ctime     :   2020-05-12
# Mtime     :   2022-12-03
# Path      :   pgsql.yml
# Author    :   Ruohang Feng (rh@vonng.com)
# License   :   AGPLv3
#==============================================================#
- name: PGSQL INIT
  become: yes
  hosts: all
  gather_facts: no
  roles:
    - { role: node_id     , tags: node-id  } # get node identity (always)
    - { role: pg_id       , tags: pg-id    } # get pgsql identity (always)
    - { role: postgres    , tags: pgsql    } # init postgres cluster/instance
      # -  pg_clean   : cleanup existing postgres if necessary
      # -  pg_dbsu    : setup os user sudo for postgres dbsu
      # -  pg_install : install postgres packages & extensions
      # -  pg_dir     : create postgres directories and setup fhs
      # -  pg_util    : copy utils scripts, setup alias and env
      # -  patroni    : bootstrap postgres with patroni
      #     -  pg_config : generate patroni config
      #     -  pg_cert   : issues certificates for postgres
      #     -  pg_launch : launch postgres primary & replicas
      # -  pg_user    : provision postgres business users
      # -  pg_db      : provision postgres business databases
      # -  pgbackrest : create a backup repo on pgsql primary
      # -  pgbouncer  : deploy a pgbouncer sidecar with postgres
      # -  pg_vip     : bind vip to pgsql primary with vip-manager
      # -  pg_service : expose pgsql service with haproxy
    - { role: pg_exporter , tags: monitor  } # setup postgres monitor
    - { role: pg_register , tags: register } # register postgres services


#==============================================================#
# Playbook : Init PGSQL Cluster/Instance on Pigsty Node
#==============================================================#
#  Warning: You have to run this playbook on provisioned nodes
#  which should be provisioned by ./node.yml playbook ahead
#  you can run both at once with bin/createpg <cluster|ip>
#    bin/createpg pg-test
#
#  Init cluster `pg-test`
#     pgsql.yml -l pg-test
#
#  Init instance (10.10.10.13) among cluster `pg-test`
#     pgsql.yml -l 10.10.10.13
#
#  Re-init postgres instance only on node 10.10.10.13
#     pgsql.yml -l 10.10.10.13 --tags=postgres
#
#  Re-init pgbouncer instance only on node 10.10.10.13
#     pgsql.yml -l 10.10.10.13 --tags=pgbouncer
#
#  Re-deploy monitor component
#     pgsql.yml --tags=monitor
#
#  Refresh HBA rules
#     pgsql.yml --tags=pg_hba   (or bin/reloadhba <cluster>)
##    pgsql.yml --tags=pgb_hba  (or bin/reloadhba <cluster>)
#
#  Register cluster/instance to infrastructure
#     pgsql.yml --tags=register             # register all
#     pgsql.yml --tags=register_prometheus  # monitor target
#     pgsql.yml --tags=register_grafana     # pgsql datasource
#==============================================================#
...