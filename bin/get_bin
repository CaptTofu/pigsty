#!/bin/bash
set -euo pipefail

#==============================================================#
# File      :   get_bin
# Ctime     :   2021-04-22
# Mtime     :   2021-04-22
# Desc      :   Get Binary Packages From Internet or Cache
# Path      :   bin/get_bin
# Usage     :   get_bin [cache_dir]
# Note      :   if cache not found, will download from internet
#               extract pkg.tgz first to get from cache
# Depend    :   curl, unzip
# Copyright (C) 2018-2021 Ruohang Feng
#==============================================================#

PROG_NAME="$(basename $0))"
PROG_DIR="$(cd $(dirname $0) && pwd)"
PIGSTY_HOME="$(cd $(dirname ${PROG_DIR}) && pwd)"

#========================================#
# parameters
#========================================#
REPO_NAME=pigsty
REPO_HOME=/www
REPO_DIR=${REPO_HOME}/${REPO_NAME}

#========================================#
# make sure target bin dir exists
#========================================#
BIN_DIR=${PIGSTY_HOME}/files/bin
[[ -f ${BIN_DIR} ]] && rm -rf ${BIN_DIR}
mkdir -p ${BIN_DIR}

#========================================#
# make sure cache dir exists
#========================================#
CACHE_DIR=${1-${REPO_DIR}}
TARGET_DIR=${2-${BIN_DIR}}
printf "\033[0;32m[WARN] cache dir ${CACHE_DIR} , target dir ${TARGET_DIR} \033[0m\n" >&2
mkdir -p ${CACHE_DIR} ${REPO_DIR}

#========================================#
# extract or download bin
#========================================#
cd ${PIGSTY_HOME}  # pigsty/bin
bin/get_node_exporter -t ${CACHE_DIR}  -v 1.1.2  -p ${TARGET_DIR}/node_exporter
bin/get_pg_exporter   -t ${CACHE_DIR}  -v 0.3.2  -p ${TARGET_DIR}/pg_exporter
bin/get_loki          -t ${CACHE_DIR}  -v 2.2.1  -p ${TARGET_DIR}
chown ${TARGET_DIR}/* -Rv --reference=${TARGET_DIR}
