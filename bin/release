#!/bin/bash
set -euo pipefail

#==============================================================#
# File      :   release
# Ctime     :   2021-04-20
# Mtime     :   2021-04-20
# Desc      :   release pigsty
# Note      :   run this as ROOT on INITIALIZED META NODE!
# Path      :   bin/release
# Copyright (C) 2018-2021 Ruohang Feng
#==============================================================#

PROG_NAME="$(basename $0))"
PROG_DIR="$(cd $(dirname $0) && pwd)"

PIGSTY_VERSION=${1}

# pigsty home directory
PIGSTY_HOME="$(cd $(dirname ${PROG_DIR}) && pwd)"
RELEASE_DIR=${PIGSTY_HOME}/files/release
cd ${PIGSTY_HOME}

# create release version dir
DIR="${RELEASE_DIR}/v${PIGSTY_VERSION}"
mkdir -p "${DIR}"


#==============================================================#
# source code dir
#==============================================================#
rm -rf "${DIR}/pigsty"
mkdir -p "${DIR}/pigsty"
mkdir -p "${DIR}/pigsty/files/bin"
mkdir -p "${DIR}/pigsty/vagrant"


#==============================================================#
# copy resources
#==============================================================#
cp -r ${PIGSTY_HOME}/{README.md,LICENSE,KEYS,NOTICE,Makefile}           "${DIR}/pigsty/"                 # copy text files
cp -r ${PIGSTY_HOME}/ansible.cfg                                        "${DIR}/pigsty/"                 # copy ansible config
cp -r ${PIGSTY_HOME}/{bin,roles,templates}                              "${DIR}/pigsty/"                 # copy scripts, playbooks
cp -r ${PIGSTY_HOME}/vagrant/{Vagrantfile,ssh,provision.sh}             "${DIR}/pigsty/vagrant"          # copy sandbox resources
cp -r ${PIGSTY_HOME}/{infra,infra-loki,sandbox,node,node-remove}.yml    "${DIR}/pigsty/"                 # copy infra playbooks
cp -r ${PIGSTY_HOME}/node*.yml                                          "${DIR}/pigsty/"                 # copy node playbooks
cp -r ${PIGSTY_HOME}/infra*.yml                                         "${DIR}/pigsty/"                 # copy infra playbooks
cp -r ${PIGSTY_HOME}/pgsql*.yml                                         "${DIR}/pigsty/"                 # copy pgsql playbooks
cp -r ${PIGSTY_HOME}/pigsty.yml                                         "${DIR}/pigsty/"                 # copy pigsty config
cp -r ${PIGSTY_HOME}/files/metadb                                       "${DIR}/pigsty/files/metadb"     # copy pigsty metadb schema
cp -r ${PIGSTY_HOME}/files/pigsty.yml                                   "${DIR}/pigsty/files/pigsty.yml" # copy pigsty single-node template
cp -r ${PIGSTY_HOME}/files/pigsty-full.yml                              "${DIR}/pigsty/files/pigsty-full.yml"


#============================#
# pro
#============================#
# handle pro resources
cp -r ${PIGSTY_HOME}/files/public.tgz                                   "${DIR}/pigsty/files/public.tgz" # copy pigsty pro resource
cd ${DIR} && tar -zcf "${DIR}/pigsty-pro.tgz" pigsty

#============================#
# standard
#============================#
rm -rf "${DIR}/pigsty/files/public.tgz"
rm -rf "${DIR}/pigsty/roles/grafana/files/dashboards/pigsty-full"                                        # remove pro dashboards
cd ${DIR} && tar -zcf "${DIR}/pigsty.tgz" pigsty

