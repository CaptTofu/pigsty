---
######################################################################
# File      :   pigsty-build.yml
# Desc      :   Pigsty el building environment
# Link      :   https://github.com/Vonng/pigsty/wiki/Configuration
# Ctime     :   2022-10-12
# Mtime     :   2022-11-11
# Note      :   building el7, el8, el9 offline packages with this
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
######################################################################

######################################################################
#                    Spec (3-node, build.rb)                         #
#====================================================================#
# 1.  meta   : 10.10.10.10  (2 Core | 4GB)  CentOS 7.9               #
# 2.  node-1 : 10.10.10.11  (2 Core | 4GB)  Rocky 8.6                #
# 3.  node-2 : 10.10.10.12  (2 Core | 4GB)  Rocky 9.0                #
######################################################################

all:

  vars:
    version: v2.0.0-a1
    meta_ip: 10.10.10.10
    region: china
    etcd_clean: true
    pg_clean: true
    docker_registry_mirrors: ["https://registry.cn-hangzhou.aliyuncs.com"]

  children:

    meta:
      vars:
        meta_node: true
        nginx_enabled: true
        ansible_group_priority: 99
      hosts:
        10.10.10.10: { }
        10.10.10.11: { }
        10.10.10.12: { }

    etcd: # dcs service for postgres/patroni ha consensus
      hosts:  # 1 node for testing, 3 or 5 for production
        10.10.10.10: { etcd_seq: 1 }  # etcd_seq required
        10.10.10.11: { etcd_seq: 2 }  # assign from 1 ~ n
        10.10.10.12: { etcd_seq: 3 }  # odd number please
      vars: # cluster level parameter override roles/etcd
        etcd_cluster: etcd  # mark etcd cluster name etcd
        etcd_safeguard: false # safeguard against purging
        etcd_clean: true # purge etcd during init process

    # build el7 packages on CentOS 7.9
    pg-el7:
      hosts: { 10.10.10.10: { pg_seq: 1, pg_role: primary } }
      vars:
        meta_ip: 10.10.10.10
        pg_cluster: pg-el7
        repo_packages:                    # which packages to be included
          - epel-release nginx wget createrepo_c sshpass zip unzip chrony yum yum-utils #modulemd-tools
          - uuid lz4 bzip2 netcat pv jq vim-enhanced make patch bash lsof wget git tuned perf ftp lrzsz rsync nvme-cli numactl grubby sysstat dstat iotop bind-utils net-tools tcpdump socat ipvsadm telnet audit ca-certificates
          - readline zlib openssl openssh-clients libyaml libxml2 libxslt libevent readline-devel zlib-devel uuid-devel libuuid-devel libxml2-devel libxslt-devel openssl-devel libicu-devel perl perl-devel perl-ExtUtils* s3cmd
          - clang coreutils diffutils rpm-build rpm-devel rpmlint rpmdevtools bison flex docker-ce docker-compose* # kubelet kubectl kubeadm kubernetes-cni helm
          - grafana*.x86_64 prometheus2 pushgateway alertmanager mtail etcd dnsmasq node_exporter nginx_exporter blackbox_exporter redis_exporter #redis haproxy
          - ansible python3 python3-pip python3-requests python3-psycopg2 python3-psycopg3 python3-etcd python3-urllib3 python3-idna python36-pyOpenSSL
          - postgresql14* pg_repack_14 wal2json_14 pglogical_14* postgis33_14* citus111_14* timescaledb-2-postgresql-14
          - postgresql15* pg_repack_15 wal2json_15 pglogical_15* postgis33_15* citus111_15* #timescaledb-2-postgresql-15
          - patroni patroni-etcd pgbouncer pgbadger tail_n_mail pgbackrest boxinfo check_postgres barman barman-cli pgFormatter pitrery pspg PyGreSQL pgloader pg_activity
          - pg_qualstats_14 pg_stat_kcache_14 pg_stat_monitor_14 pg_top_14 pg_track_settings_14 pg_wait_sampling_14 plsh_14 pldebugger_14 plpgsql_check_14 postgresql_faker_14
          - mysql_fdw_14 ogr_fdw_14 sqlite_fdw_14 firebird_fdw_14 hdfs_fdw_14 mongo_fdw_14 pgbouncer_fdw_14 hypopg_14 geoip_14 tdigest_14 multicorn2_14 pg_ivm_14 semver_14
          - bgw_replstatus_14 ddlx_14 mysqlcompat_14 orafce_14 repmgr_14 pg_auto_failover_14 pg_catcheck_14 pg_cron_14 pg_fkpart_14 pg_jobmon_14 pg_partman_14 pg_permissions_14
          - pg_readonly_14 pgagent_14 pgaudit16_14 pgauditlogtofile_14 pgfincore_14 powa_14 pgq_14 pgsql_tweaks_14 pgtt_14 postgresql-unit_14 postgresql_anonymizer_14 rum_14
          - pg_statement_rollback_14 system_stats_14 plproxy_14 pgmemcache_14 hll_14 ip4r_14 prefix_14 pguri_14 topn_14 periods_14
          - count_distinct_14 credcheck_14 extra_window_functions_14 logerrors_14 pg_auth_mon_14 pg_background_14 pg_bulkload_14 pg_comparator_14
          - pg_prioritize_14 pgcryptokey_14 pgexportdoc_14 pgimportdoc_14 pgmp_14 pgtap_14 safeupdate_14 set_user_14 sslutils_14 table_version_14
        repo_url_packages:                # extra packages from url
          - http://download.pigsty.cc/rpm/loki-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/promtail-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pg_exporter-0.5.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/vip-manager-1.0.2-1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pev.html
          - http://download.pigsty.cc/rpm/polysh-0.4-1.noarch.rpm
          - http://download.pigsty.cc/rpm/redis-6.2.7-1.el7.remi.x86_64.rpm
          - http://download.pigsty.cc/rpm/haproxy-2.6.6-1.el7.x86_64.rpm
          - http://download.pigsty.cc/rpm/minio-20221111034420.0.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/mcli-20221107234739.0.0.x86_64.rpm
        node_packages: [ ]                # extra packages for all nodes
        node_packages_default:            # common packages for all nodes
          - chrony,zip,unzip,bzip2,lz4,netcat,pv,jq,wget,sshpass,uuid,make,patch,bash,lsof,git,ftp,perf,rsync,tuned,ca-certificates
          - numactl,grubby,vim-minimal,sysstat,dstat,iotop,bind-utils,net-tools,tcpdump,socat,ipvsadm,telnet,perf,nvme-cli,s3cmd
          - python3,python3-pip,python3-requests,python3-psycopg2,python3-etcd,python3-urllib3,python3-idna,python36-pyOpenSSL
          - readline,zlib,openssl,openssl-libs,openssh-clients,node_exporter,etcd,promtail
        node_packages_meta:               # extra packages for meta nodes
          - grafana,prometheus2,alertmanager,loki,nginx_exporter,blackbox_exporter,pushgateway
          - nginx,pgbadger,dnsmasq,coreutils,diffutils,python3-psycopg3,postgresql14,redis
          - ansible
        node_packages_meta_pip: 'jupyterlab'

    # build el8 packages on RockyLinux 8.6
    pg-el8:
      hosts: { 10.10.10.11: { pg_seq: 1, pg_role: primary } }
      vars:
        meta_ip: 10.10.10.11
        pg_cluster: pg-el8
        repo_packages:                    # which packages to be included
          - epel-release nginx wget createrepo_c sshpass zip unzip chrony yum yum-utils #modulemd-tools
          - uuid lz4 bzip2 netcat pv jq vim-enhanced make patch bash lsof wget git tuned perf ftp lrzsz rsync nvme-cli numactl grubby sysstat dstat iotop bind-utils net-tools tcpdump socat ipvsadm telnet audit ca-certificates
          - readline zlib openssl openssh-clients libyaml libxml2 libxslt libevent readline-devel zlib-devel uuid-devel libuuid-devel libxml2-devel libxslt-devel openssl-devel libicu-devel perl perl-devel perl-ExtUtils* s3cmd
          - clang coreutils diffutils rpm-build rpm-devel rpmlint rpmdevtools bison flex docker-ce docker-compose* # kubelet kubectl kubeadm kubernetes-cni helm
          - grafana*.x86_64 prometheus2 pushgateway alertmanager mtail etcd dnsmasq node_exporter nginx_exporter blackbox_exporter redis_exporter redis haproxy
          - ansible python3 python3-pip python3-requests python3-psycopg2 python3-psycopg3 python3-etcd python3-urllib3 python3-idna python3-pyOpenSSL python38-jmespath
          - postgresql14* pg_repack_14 wal2json_14 pglogical_14* postgis33_14* citus111_14* timescaledb-2-postgresql-14
          - postgresql15* pg_repack_15 wal2json_15 pglogical_15* postgis33_15* citus111_15* #timescaledb-2-postgresql-15
          - patroni patroni-etcd pgbouncer pgbadger tail_n_mail pgbackrest boxinfo check_postgres barman barman-cli pgFormatter pitrery pspg PyGreSQL pgloader pg_activity
          - pg_qualstats_14 pg_stat_kcache_14 pg_stat_monitor_14 pg_top_14 pg_track_settings_14 pg_wait_sampling_14 plsh_14 pldebugger_14 plpgsql_check_14 postgresql_faker_14
          - mysql_fdw_14 ogr_fdw_14 sqlite_fdw_14 firebird_fdw_14 hdfs_fdw_14 mongo_fdw_14 pgbouncer_fdw_14 hypopg_14 geoip_14 tdigest_14 multicorn2_14 pg_ivm_14 semver_14
          - bgw_replstatus_14 ddlx_14 mysqlcompat_14 orafce_14 repmgr_14 pg_auto_failover_14 pg_catcheck_14 pg_cron_14 pg_fkpart_14 pg_jobmon_14 pg_partman_14 pg_permissions_14
          - pg_readonly_14 pgagent_14 pgaudit16_14 pgauditlogtofile_14 pgfincore_14 powa_14 pgq_14 pgsql_tweaks_14 pgtt_14 postgresql-unit_14 postgresql_anonymizer_14 rum_14
          - pg_statement_rollback_14 system_stats_14 plproxy_14 pgmemcache_14 hll_14 ip4r_14 prefix_14 pguri_14 topn_14 periods_14
          - count_distinct_14 credcheck_14 extra_window_functions_14 logerrors_14 pg_auth_mon_14 pg_background_14 pg_bulkload_14 pg_comparator_14
          - pg_prioritize_14 pgcryptokey_14 pgexportdoc_14 pgimportdoc_14 pgmp_14 pgtap_14 safeupdate_14 set_user_14 sslutils_14 table_version_14
        repo_url_packages:                # remove haproxy, redis, polysh on el8
          - http://download.pigsty.cc/rpm/loki-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/promtail-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pg_exporter-0.5.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/vip-manager-1.0.2-1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pev.html
          - http://download.pigsty.cc/rpm/minio-20221111034420.0.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/mcli-20221107234739.0.0.x86_64.rpm
        node_packages_default:            # common packages for all nodes
          - chrony,zip,unzip,bzip2,lz4,netcat,pv,jq,wget,sshpass,uuid,make,patch,bash,lsof,git,ftp,perf,rsync,tuned,ca-certificates
          - numactl,grubby,vim-minimal,sysstat,dstat,iotop,bind-utils,net-tools,tcpdump,socat,ipvsadm,telnet,perf,nvme-cli,s3cmd
          - python3,python3-pip,python3-requests,python3-psycopg2,python3-etcd,python3-urllib3,python3-idna,python3-pyOpenSSL
          - readline,zlib,openssl,openssl-libs,openssh-clients,node_exporter,etcd,promtail
        node_packages_meta:               # extra packages for meta nodes
          - grafana,prometheus2,alertmanager,loki,nginx_exporter,blackbox_exporter,pushgateway
          - nginx,ansible,pgbadger,dnsmasq,python3-psycopg3,python3-psycopg3,python38-jmespath,postgresql15,redis
        node_packages_meta_pip: ''        # jupyter is not ready for el8

    # build el9 packages on RockyLinux 9.0
    pg-el9:
      hosts: { 10.10.10.12: { pg_seq: 1, pg_role: primary } }
      vars:
        meta_ip: 10.10.10.12
        pg_cluster: pg-el9
        repo_packages:                    # which packages to be included
          - epel-release nginx wget createrepo_c sshpass zip unzip chrony yum yum-utils #modulemd-tools
          - uuid lz4 bzip2 netcat pv jq vim-enhanced make patch bash lsof wget git tuned perf ftp lrzsz rsync nvme-cli numactl grubby sysstat dstat iotop bind-utils net-tools tcpdump socat ipvsadm telnet audit ca-certificates
          - readline zlib openssl openssh-clients libyaml libxml2 libxslt libevent readline-devel zlib-devel uuid-devel libuuid-devel libxml2-devel libxslt-devel openssl-devel libicu-devel perl perl-devel perl-ExtUtils* s3cmd
          - clang coreutils diffutils rpm-build rpm-devel rpmlint rpmdevtools bison flex docker-ce docker-compose* # kubelet kubectl kubeadm kubernetes-cni helm
          - grafana*.x86_64 prometheus2 pushgateway alertmanager mtail etcd dnsmasq node_exporter nginx_exporter blackbox_exporter redis_exporter redis haproxy
          - ansible python3 python3-pip python3-requests python3-psycopg2 python3-psycopg3 python3-etcd python3-urllib3 python3-idna python3-pyOpenSSL python3-jmespath
          - postgresql14* pg_repack_14 wal2json_14 pglogical_14* postgis33_14* #citus111_14* timescaledb-2-postgresql-14
          - postgresql15* pg_repack_15 wal2json_15 pglogical_15* postgis33_15* #citus111_15* timescaledb-2-postgresql-15
          - patroni patroni-etcd pgbouncer pgbadger tail_n_mail pgbackrest boxinfo check_postgres barman barman-cli pgFormatter pitrery pspg PyGreSQL pgloader pg_activity
          - pg_qualstats_14 pg_stat_kcache_14 pg_stat_monitor_14 pg_top_14 pg_track_settings_14 pg_wait_sampling_14 plsh_14 pldebugger_14 plpgsql_check_14 postgresql_faker_14
          - mysql_fdw_14 ogr_fdw_14 sqlite_fdw_14 firebird_fdw_14 hdfs_fdw_14 mongo_fdw_14 pgbouncer_fdw_14 hypopg_14 geoip_14 tdigest_14 multicorn2_14 pg_ivm_14 semver_14
          - bgw_replstatus_14 ddlx_14 mysqlcompat_14 orafce_14 repmgr_14 pg_auto_failover_14 pg_catcheck_14 pg_cron_14 pg_fkpart_14 pg_jobmon_14 pg_partman_14 pg_permissions_14
          - pg_readonly_14 pgagent_14 pgaudit16_14 pgauditlogtofile_14 pgfincore_14 powa_14 pgq_14 pgsql_tweaks_14 pgtt_14 postgresql-unit_14 postgresql_anonymizer_14 rum_14
          #- pg_statement_rollback_14 system_stats_14 plproxy_14 pgmemcache_14 hll_14 ip4r_14 prefix_14 pguri_14 topn_14 periods_14
          #- count_distinct_14 credcheck_14 extra_window_functions_14 logerrors_14 pg_auth_mon_14 pg_background_14 pg_bulkload_14 pg_comparator_14
          #- pg_prioritize_14 pgcryptokey_14 pgexportdoc_14 pgimportdoc_14 pgmp_14 pgtap_14 safeupdate_14 set_user_14 sslutils_14 table_version_14
        repo_url_packages:                # remove haproxy, redis, polysh on el8
          - http://download.pigsty.cc/rpm/loki-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/promtail-2.6.1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pg_exporter-0.5.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/vip-manager-1.0.2-1.x86_64.rpm
          - http://download.pigsty.cc/rpm/pev.html
          - http://download.pigsty.cc/rpm/minio-20221111034420.0.0.x86_64.rpm
          - http://download.pigsty.cc/rpm/mcli-20221107234739.0.0.x86_64.rpm
        node_packages_default:            # common packages for all nodes
          - chrony,zip,unzip,bzip2,lz4,netcat,pv,jq,wget,sshpass,uuid,make,patch,bash,lsof,git,ftp,perf,rsync,tuned,ca-certificates
          - numactl,grubby,vim-minimal,sysstat,dstat,iotop,bind-utils,net-tools,tcpdump,socat,ipvsadm,telnet,perf,nvme-cli,s3cmd
          - python3,python3-pip,python3-requests,python3-psycopg2,python3-etcd,python3-urllib3,python3-idna,python3-pyOpenSSL
          - readline,zlib,openssl,openssl-libs,openssh-clients,node_exporter,etcd,promtail
        node_packages_meta:               # extra packages for meta nodes
          - grafana,prometheus2,alertmanager,loki,nginx_exporter,blackbox_exporter,pushgateway
          - nginx,ansible,pgbadger,dnsmasq,python3-psycopg3,python3-jmespath,python3-pip,postgresql15,redis
        node_packages_meta_pip: ''        # jupyter is not ready for el8
        pg_extensions:                    # postgresql extensions, citus & timescaledb are not ready for el9
          - postgis33_${pg_version}* pg_repack_${pg_version} wal2json_${pg_version} # citus111_${pg_version} timescaledb-2-postgresql-${pg_version}

...