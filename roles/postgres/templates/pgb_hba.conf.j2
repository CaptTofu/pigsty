{% set hostssl = 'host' %}
{% if pg_sslmode not in ('disable', 'allow', 'prefer') %}
{% set hostssl = 'hostssl' %}
{% endif %}
#==============================================================#
# Default HBA
#==============================================================#
# local dbsu quick access
local    pgbouncer    postgres                         peer

# local all password access
local    all          all                              {{ pg_pwd_enc }}
host     all          all              127.0.0.1/32    {{ pg_pwd_enc }}

# monitor user intranet monitor access
{{hostssl}}     pgbouncer    {{ pg_monitor_username }}   10.0.0.0/8      {{ pg_pwd_enc }}
{{hostssl}}     pgbouncer    {{ pg_monitor_username }}   172.16.0.0/12   {{ pg_pwd_enc }}
{{hostssl}}     pgbouncer    {{ pg_monitor_username }}   192.168.0.0/16  {{ pg_pwd_enc }}
{{hostssl}}     all          {{ pg_monitor_username }}   0.0.0.0/0       reject

{% if admin_ip is defined and admin_ip != '' %}
# admin node everyone access with password
{{hostssl}}     all          all              {{ admin_ip }}/32   {{ pg_pwd_enc }}
{% endif %}

{% if not pgbouncer_auth_query|bool %}
# admin user intranet admin access with password
{{hostssl}}      pgbouncer    {{ pg_admin_username }}      10.0.0.0/8      {{ pg_pwd_enc }}
{{hostssl}}      pgbouncer    {{ pg_admin_username }}      172.16.0.0/12   {{ pg_pwd_enc }}
{{hostssl}}      pgbouncer    {{ pg_admin_username }}      192.168.0.0/16  {{ pg_pwd_enc }}
{{hostssl}}      all          {{ pg_admin_username }}      0.0.0.0/0       reject
{% endif %}

#==============================================================#
# Common HBA
#==============================================================#
{% for hba in pgb_default_hba_rules %}
{% if hba.role == 'common' %}
# {% if 'title' in hba %}{{ hba.title }}{% endif %}

{% for rule in hba.rules %}
{{ rule }}
{% endfor %}

{% endif %}
{% endfor %}


#==============================================================#
# {{ pg_role }} HBA
#==============================================================#
{% for hba in pgb_default_hba_rules %}
{% if hba.role == pg_role %}
# {% if 'title' in hba %}{{ hba.title }}{% endif %}

{% for rule in hba.rules %}
{{ rule }}
{% endfor %}
{% endif %}
{% endfor %}


#==============================================================#
# Extra HBA
#==============================================================#
# add extra hba rules here

{% for hba in pgb_hba_rules %}
{% if hba.role == 'common' %}
# {% if 'title' in hba %}{{ hba.title }}{% endif %}

{% for rule in hba.rules %}
{{ rule }}
{% endfor %}

{% endif %}
{% endfor %}

{% for hba in pgb_hba_rules %}
{% if hba.role == pg_role %}
# {% if 'title' in hba %}{{ hba.title }}{% endif %}

{% for rule in hba.rules %}
{{ rule }}
{% endfor %}
{% endif %}
{% endfor %}


#==============================================================#
# Ad Hoc HBA
#==============================================================#
# manual maintained hba rules
