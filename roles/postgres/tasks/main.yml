---
#------------------------------------------------------------------------------
# Clean
#------------------------------------------------------------------------------
- import_tasks: clean.yml
  tags: pg_clean

#------------------------------------------------------------------------------
# User
#------------------------------------------------------------------------------
- import_tasks: dbsu.yml
  tags: pg_dbsu

#------------------------------------------------------------------------------
# Install
#------------------------------------------------------------------------------
- import_tasks: install.yml
  tags: pg_install

#------------------------------------------------------------------------------
# Directory
#------------------------------------------------------------------------------
- import_tasks: dir.yml
  tags: pg_dir

#------------------------------------------------------------------------------
# Utils
#------------------------------------------------------------------------------
- import_tasks: util.yml
  tags: pg_util

#------------------------------------------------------------------------------
# Config
#------------------------------------------------------------------------------
- import_tasks: config.yml
  tags: [ patroni, pg_config ]
  when: patroni_enabled|bool

#------------------------------------------------------------------------------
# Cert
#------------------------------------------------------------------------------
- import_tasks: cert.yml
  tags: [ patroni, pg_cert ]
  when: patroni_ssl_enabled|bool or pg_sslmode != 'disable'

#------------------------------------------------------------------------------
# Launch
#------------------------------------------------------------------------------
# bootstrap postgres cluster with patroni (skip if patroni_enabled = false)
- import_tasks: patroni.yml
  tags: [ patroni, pg_launch ]
  when: patroni_enabled|bool

#------------------------------------------------------------------------------
# Pgbouncer
#------------------------------------------------------------------------------
# install connection pooling middleware
- import_tasks: pgbouncer.yml
  tags: pgbouncer
  when: pgbouncer_enabled|bool

#------------------------------------------------------------------------------
# Users
#------------------------------------------------------------------------------
- include_tasks: createuser.yml
  tags: pg_user
  when: pg_provision|bool
  vars:
    user: "{{ item }}"
  with_items: "{{ pg_users }}"

#------------------------------------------------------------------------------
# Databases
#------------------------------------------------------------------------------
- include_tasks: createdb.yml
  when: pg_provision|bool
  tags: pg_db
  vars:
    database: "{{ item }}"
  with_items: "{{ pg_databases }}"

#------------------------------------------------------------------------------
# Pgbouncer Reload
#------------------------------------------------------------------------------
- name: reload pgbouncer to finish provision
  tags: pgbouncer_reload
  when: pgbouncer_enabled|bool and pg_provision|bool
  systemd: name=pgbouncer state=reloaded enabled=yes daemon_reload=yes

#------------------------------------------------------------------------------
# Backup
#------------------------------------------------------------------------------
- import_tasks: backup.yml
  tags: pg_backup
...