---
#------------------------------------------------------------------------------
# Create Business Database
#------------------------------------------------------------------------------
- name: create postgres database
  tags: pg_db
  when: pg_role == 'primary'
  block:
    - debug:
        msg: "{{ database }}"

    - name: render sql for database {{ database.name }}
      tags: pg_db_config
      template: src="pg-db.sql" dest=/pg/tmp/pg-db-{{ database.name }}.sql owner={{ pg_dbsu }} group=postgres mode=0755

    - name: copy baseline for database {{ database.name }}
      tags: pg_db_config
      when: database.baseline is defined
      copy: src="{{ database.baseline }}" dest=/pg/tmp/pg-db-{{ database.name }}-baseline.sql owner={{ pg_dbsu }} group=postgres mode=0755

    # create database with shell command, check database exists as success
    - name: create database {{ database.name }} with shell command
      tags: pg_db_create
      ignore_errors: true
      become_user: "{{ pg_dbsu }}"
      shell: |
        createdb -w -h {{ pg_localhost }} -p {{ pg_port }} {% if 'owner' in  database and database.owner != '' %}-O "{{ database.owner }}" {% endif %}
        {% if 'template'   in  database and database.template != ''   %}-T '{{ database.template   }}' {% endif %}
        {% if 'encoding'   in  database and database.encoding != ''   %}-E '{{ database.encoding   }}' {% endif %}
        {% if 'locale'     in  database and database.locale != ''     %}-l '{{ database.locale     }}' {% endif %}
        {% if 'tablespace' in  database and database.tablespace != '' %}-D '{{ database.tablespace }}' {% endif %}
        '{{ database.name }}' || true
        db_exists=$(psql -h {{ pg_localhost }} -p {{ pg_port }} -AXtwq postgres -c "SELECT true WHERE EXISTS(SELECT * FROM pg_database WHERE datname = '{{ database.name }}' LIMIT 1);")
        [[ -z "${db_exists}" ]] && exit 1 || exit 0

    - name: execute init sql for database {{ database.name }}
      tags: pg_db_create
      ignore_errors: true
      become_user: "{{ pg_dbsu }}"
      command: psql {{ database.name }} -h {{ pg_localhost }} -p {{ pg_port }} -AXtwqf /pg/tmp/pg-db-{{ database.name }}.sql

    - name: load baseline for database {{ database.name }}
      tags: pg_db_create
      ignore_errors: true
      become_user: "{{ pg_dbsu }}"
      command: psql {{ database.name }} -h {{ pg_localhost }} -p {{ pg_port }} -AXtwqf /pg/tmp/pg-db-{{ database.name }}-baseline.sql
      when: database.baseline is defined


# pgbouncer databases are added to /etc/pgbouncer/database.txt
- name: add business database to pgbouncer
  tags: [pg_db, pg_db_pgbouncer]
  when: pgbouncer_enabled|bool
  ignore_errors: true
  become_user: "{{ pg_dbsu }}"
  shell: /bin/bash /pg/bin/pgbouncer-create-db '{{ database.name }}'

...