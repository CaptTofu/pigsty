---
#------------------------------------------------------------------------------
# register postgres service to consul
#------------------------------------------------------------------------------
- name: Register postgres service to consul
  tags: pg_register
  when: service_registry == 'consul'
  block:
    - name: Copy pg service definition to consul
      template:
        src: svc-{{ item }}.json.j2
        dest: /etc/consul.d/svc-{{ item }}.json
        owner: consul
        group: postgres
        mode: 0660
      with_items:
        - postgres
        - pgbouncer
        - patroni

    - name: Reload postgres consul service
      systemd: name=consul state=reloaded

...