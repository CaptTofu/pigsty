---
#--------------------------------------------------------------#
# Register Postgres Datasource to Grafana
#--------------------------------------------------------------#
- name: register pg database as grafana datasource
  tags: datasource
  delegate_to: "{{ admin_ip }}"
  block:

    #--------------------------------------------------------------#
    # render datasource definition to:
    # /etc/pigsty/datasources/{{ pg_instance }}.{{ dbname }}.json
    #--------------------------------------------------------------#
    - name: render grafana datasource definition
      copy:
        dest: "/etc/pigsty/datasources/{{ name }}.json"
        content: |
          {
            "type": "postgres",
            "access": "proxy",
            "name": "{{ name }}",
            "url": "{{ host }}:{{ port }}",
            "user": "{{ username }}",
            "database": "{{ dbname }}",
            "typeLogoUrl": "",
            "basicAuth": false,
            "basicAuthUser": "",
            "basicAuthPassword": "",
            "withCredentials": false,
            "isDefault": false,
            "jsonData": {
              "connMaxLifetime": 3600,
              "maxIdleConns": 1,
              "maxOpenConns": 8,
              "postgresVersion": {{ pg_version }}00,
              "sslmode": "require",
              "tlsAuth": false,
              "tlsAuthWithCACert": false
            },
            "secureJsonData":{
              "password": "{{ password }}"
            }
          }
        mode: 0600
      vars:
        name: "{{ pg_cluster }}-{{ pg_seq }}.{{ item.name }}"
        host: "{{ inventory_hostname }}"
        port: "{{ pg_port }}"
        username: "{{ pg_monitor_username }}"
        password: "{{ pg_monitor_password }}"
        dbname: "{{ item.name }}"
      with_items: "{{ pg_databases }}"


    #--------------------------------------------------------------#
    # upsert datasource using grafana datasource API
    #--------------------------------------------------------------#
    - name: load grafana datasource
      when: db_def.register_datasource is not defined or db_def.register_datasource|bool
      delegate_to: "{{ admin_ip }}"
      shell: |
        curl -X DELETE "{{ endpoint }}/api/datasources/name/{{ name }}" -u "{{ username }}:{{ password }}"  -H 'Content-Type: application/json' 
        curl -X POST   "{{ endpoint }}/api/datasources/" -u "{{ username }}:{{ password }}" -H 'Content-Type: application/json' -d @/etc/pigsty/datasources/{{ name }}.json
      vars:
        name: "{{ pg_cluster }}-{{ pg_seq }}.{{ item.name }}"
        endpoint: "{{ grafana_endpoint|regex_replace('\\${admin_ip}', admin_ip) }}"
        username: "{{ grafana_admin_username }}"
        password: "{{ grafana_admin_password }}"
      with_items: "{{ pg_databases }}"

...