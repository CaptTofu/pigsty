---
#--------------------------------------------------------------#
# Register Haproxy Services
#--------------------------------------------------------------#
- name: render postgres service config
  tags: pg_service
  block:

    - name: wipe existing postgres haproxy service
      when: haproxy_clean is defined and haproxy_clean|bool
      shell: "cd /etc/haproxy; rm -rf {{ pg_cluster }}-*.cfg;"

    - name: render haproxy service config
      template: src=service.j2 dest=/etc/haproxy/{{ service_name }}.cfg owner=root mode=0644
      vars:
        service: "{{ item }}"
        service_name: "{{ pg_cluster }}-{{ item.name }}"
        pg_cluster_members_query: "[@.*][0][?pg_cluster=='{{ pg_cluster }}']"
      with_items: "{{ pg_default_services + pg_services }}"

    - name: reload haproxy
      tags: [ haproxy_reload , haproxy_config ]
      ignore_errors: false
      systemd: name=haproxy state=reloaded enabled=yes daemon_reload=yes
...