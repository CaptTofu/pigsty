---
#--------------------------------------------------------------#
# Create DNS Dir                                       [dns_dir]
#--------------------------------------------------------------#
- name: create dns records dir
  tags: dns_dir
  file: path=/etc/hosts.d/ state=directory

#--------------------------------------------------------------#
# Config DNS                                        [dns_config]
#--------------------------------------------------------------#
- name: render /etc/dnsmasq.d/config
  tags: dns_config
  template: src=dnsmasq.conf.j2 dest=/etc/dnsmasq.conf


#--------------------------------------------------------------#
# Write DNS Records                                 [dns_record]
#--------------------------------------------------------------#
- name: add dynamic dns records
  tags: dns_record
  lineinfile: path=/etc/hosts.d/default line="{{ item }}"
  with_items: "{{ dns_records }}"


#--------------------------------------------------------------#
# Write DNS Records                                 [dns_launch]
#--------------------------------------------------------------#
- name: launch dnsmasq systemd service
  tags: dns_launch
  when: dns_enabled|bool
  block:

    - name: launch dnsmasq systemd service
      systemd: name=dnsmasq state=restarted enabled=yes daemon_reload=yes
    - name: wait for dnsmasq service online
      wait_for: host=127.0.0.1 port={{ dns_port }} state=started

...