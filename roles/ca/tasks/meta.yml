---
#------------------------------------------------------------------------------
# node cert
#------------------------------------------------------------------------------
- name: Generate node cert
  delegate_to: "{{ meta_ip }}"
  block:

    - name: Generate etcd private key
      openssl_privatekey:
        path: "/etc/pki/CA/private/meta-{{ inventory_hostname }}.key"
        mode: 0600

    - name: Generate etcd server csr
      openssl_csr:
        path: "/etc/pki/CA/newcerts/meta-{{ inventory_hostname }}.csr"
        privatekey_path: "/etc/pki/CA/private/meta-{{ inventory_hostname }}.key"
        common_name: "{{ inventory_hostname }}"
        subject_alt_name:
          - DNS:localhost
          - "DNS:{{ nodename }}"
          - IP:127.0.0.1
          - "IP:{{ inventory_hostname }}"

    - name: Sign etcd server crt
      openssl_certificate:
        path: "/etc/pki/CA/certs/meta-{{ inventory_hostname }}.crt"
        csr_path: "/etc/pki/CA/newcerts/meta-{{ inventory_hostname }}.csr"
        ownca_path: /etc/pki/ca.crt
        ownca_privatekey_path: /etc/pki/ca.key
        provider: ownca
        selfsigned_not_after: "+{{ cert_validity }}"
        mode: 0644

    - name: Make sure local directory exists
      delegate_to: localhost
      become: no
      file: path="files/pki/{{ inventory_hostname }}" state=directory
    - name: Fetch etcd cert & key from primary meta node
      fetch: src={{ item.src }} dest={{ item.dest }} flat=yes
      with_items:
        - { src: "/etc/pki/CA/certs/meta-{{ inventory_hostname }}.crt"   , dest: "files/pki/{{ inventory_hostname }}/meta.crt" }
        - { src: "/etc/pki/CA/private/meta-{{ inventory_hostname }}.key" , dest: "files/pki/{{ inventory_hostname }}/meta.key" }

- name: Copy node certs
  block:
    - name: Copy node ssl cert
      copy: src="files/pki/{{ inventory_hostname }}/node.crt" dest="/etc/pki/meta.crt" owner=root group=root mode=0644
    - name: Copy node ssl key
      copy: src="files/pki/{{ inventory_hostname }}/node.key" dest="/etc/pki/meta.key" owner=root group=root mode=0644
...