---
#--------------------------------------------------------------------------
# Make Sure Self-Signed Root CA Exists on All Meta Nodes
#   ca_method (create|copy|recreate)
#     * none     : skip ca creation at all
#     * copy     : copy ca.{key,crt} from local files directly
#     * create   : create ca.{key|crt} if not exist on meta
#     * recreate : force recreate ca key & file on meta
#--------------------------------------------------------------------------

#--------------------------------------------------------------------------
#  FHS
#--------------------------------------------------------------------------
# /etc/pki/ca.crt    root 644 , all nodes
# /etc/pki/ca.key    root 600 , meta nodes
# /etc/pki/ca-trust/source/anchors/ca.crt root 644 all nodes
#--------------------------------------------------------------------------

#------------------------------------------------------------------------------
# CA Dir
#------------------------------------------------------------------------------
# This is created by default on all EL releases
- name: create ca directory on meta nodes
  tags: ca_dir
  when: meta_node|bool and ca_method != 'none'
  file: path="/etc/pki/CA" state=directory mode=0755

#------------------------------------------------------------------------------
# CA Create (on primary meta node)
#------------------------------------------------------------------------------
# create ca cert on meta nodes and copy to local files/pki dir when ca_method = (create,recreate)
# when ca_method = copy : it's user's responsibility to make sure ca exists under files/pki dir
# available tags for ca_create: ca_check, ca_gen, ca_fetch
# run on primary meta nodes (${meta_ip})
- import_tasks: create.yml
  tags: ca_create
  when: meta_ip == inventory_hostname and ca_method != 'none' and ca_method != 'copy'

#------------------------------------------------------------------------------
# CA Sync (on all meta nodes)
#------------------------------------------------------------------------------
# run on meta nodes:  primary meta node -> other meta nodes
# sync ca.crt & ca.key to all meta nodes in case of primary meta node failure
- name: sync ca cert and key to meta nodes
  tags: ca_sync
  when: meta_node|bool and ca_method != 'none'
  copy: src={{ item.src }} dest={{ item.dest }} mode={{ item.mode }} owner=root group=root
  with_items:
    - {src: files/pki/ca.crt, dest: /etc/pki/ca.crt  , mode: 644 }
    - {src: files/pki/ca.key, dest: /etc/pki/ca.key  , mode: 600 }


#------------------------------------------------------------------------------
# Meta Cert
#------------------------------------------------------------------------------
# issue meta cert on meta nodes
- import_tasks: meta.yml
  tags: ca_meta
  when: meta_node|bool and ca_method != 'none'

...