---
#--------------------------------------------------------------------------
# Make Sure Self-Signed Root CA Exists on All Meta Nodes
#   ca_method (create|copy|recreate)
#     * none     : skip ca creation at all
#     * copy     : copy ca.{key,crt} from local files directly
#     * create   : create ca.{key|crt} if not exist on meta
#     * recreate : force recreate ca key & file on meta
#--------------------------------------------------------------------------

#------------------------------------------------------------------------------
# CA Dir
#------------------------------------------------------------------------------
- name: Make sure certs dir exists on primary meta node
  tags: ca_dir
  file: path="/etc/pigsty/ca" state=directory mode=0755

#------------------------------------------------------------------------------
# CA Create (on primary meta node)
#------------------------------------------------------------------------------
# create ca cert on meta nodes and copy to local when ca_method = (create,recreate)
# and it's user's responsibility to make sure ca exists under local files dir when ca_method = copy
- import_tasks: create.yml
  when: meta_ip == inventory_hostname and ca_method != 'none' and ca_method != 'copy'

#------------------------------------------------------------------------------
# CA Dist (to all meta nodes)
#------------------------------------------------------------------------------
- name: Dist ca key/cert to all meta nodes
  copy: src="files/{{ item }}" dest="/etc/pigsty/ca/{{ item }}" owner=root mode=0644
  tags: ca_dist
  when: ca_method != 'none' and meta_node|bool
  with_items:
    - ca.key
    - ca.crt
...
