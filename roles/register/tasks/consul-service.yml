---
#--------------------------------------------------------------#
# Register Postgres Service
#--------------------------------------------------------------#
- name: Copy pgsql service definition to consul
  tags: register_consul_postgres
  template:
    src: svc-{{ item }}.json.j2
    dest: /etc/consul.d/svc-{{ item }}.json
    owner: consul
    group: postgres
    mode: 0660
  with_items:
    - postgres
    - pgbouncer
    - patroni


#--------------------------------------------------------------#
# Register Exporter Service
#--------------------------------------------------------------#
- name: Register exporter service to consul
  tags: register_consul_exporter
  template:
    src: svc-{{ item }}.json.j2
    dest: /etc/consul.d/svc-{{ item }}.json
    owner: consul
    group: postgres
    mode: 0660
  with_items:
    - node-exporter
    - pg-exporter
    - pgbouncer-exporter
    - haproxy


#--------------------------------------------------------------#
# Register Haproxy Service
#--------------------------------------------------------------#
- name: Register haproxy service to consul
  tags: register_consul_haproxy
  block:
    # register consul exposed cluster service (primary|replica|offline|default)
    - name: Render haproxy (cluster) services to consul
      template:
        src: svc-cluster-role.json.j2
        dest: /etc/consul.d/svc-{{ pg_cluster }}-{{ service.name }}.json
        owner: consul
        group: postgres
        mode: 0660
      vars:
        service: "{{ item }}"
      with_items: "{{ pg_services }}"

    # register consul exposed extra cluster service (standby|delayed|etc...)
    - name: Copy haproxy (cluster) extra services to consul
      when: pg_services_extra and pg_services_extra|length > 0
      template:
        src: svc-cluster-role.json.j2
        dest: /etc/consul.d/svc-{{ pg_cluster }}-{{ service.name }}.json
        owner: consul
        group: postgres
        mode: 0660
      vars:
        service: "{{ item }}"
      with_items: "{{ pg_services_extra }}"


#--------------------------------------------------------------#
# Reload Consul
#--------------------------------------------------------------#
- name: Reload consul to finish service register
  tags: register_consul_reload
  systemd: name=consul state=reloaded

...