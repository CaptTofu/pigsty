---
#------------------------------------------------------------------------------
# Setup DNS
#------------------------------------------------------------------------------
- name: Setup node dns records
  tags: node_dns
  block:

    # NOTE: dns records suffixed with "# pigsty meta" will be treated as meta node dns record and been wiped
    - name: Wipe pigsty node dns record
      lineinfile: path=/etc/hosts regexp='# pigsty meta$' state=absent

    # NOTE: dns records write by pigsty will be suffixed with "# pigsty meta" mark
    - name: Write static dns records to /etc/hosts
      when: node_etc_hosts_default is defined and node_etc_hosts_default|length > 0
      lineinfile:
        path: /etc/hosts
        line: "{{ item | regex_replace('\\${meta_ip}', meta_ip) }} # pigsty meta"
      with_items: "{{ node_etc_hosts_default|default([]) + node_etc_hosts|default([]) }}"

    - name: Exchange hostname among servers
      when: nodename_exchange|bool
      ignore_errors: true
      lineinfile:
        path: /etc/hosts
        line: "{{ inventory_hostname }} {{ item[0] }} # pigsty meta"
      delegate_to: "{{ item[1] }}"
      with_nested:
        - "{{ nodename }}"
        - "{{ play_hosts }}"
...