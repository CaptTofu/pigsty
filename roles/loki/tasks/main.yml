#------------------------------------------------------------------------------
# Install
#------------------------------------------------------------------------------
- name: install loki
  tags: loki_install
  package: name=loki state=present

#------------------------------------------------------------------------------
# Cleanup
#------------------------------------------------------------------------------
- name: clean up loki
  tags: loki_clean
  when: loki_clean|bool
  file: path={{ loki_data_dir }} state=absent owner=prometheus

#------------------------------------------------------------------------------
# Config
#------------------------------------------------------------------------------
- name: config loki
  tags: loki_config
  block:

    - name: touch loki data and rule directories
      file: path={{ loki_data_dir }}/data/rules/fake state=directory owner=prometheus

    - name: copy loki systemd service
      copy: src=loki.service dest=/usr/lib/systemd/system/loki.service

    - name: render loki config
      template: src=loki.yml dest=/etc/loki.yml owner=prometheus

    - name: render etc default loki config
      copy:
        dest: /etc/default/loki
        owner: prometheus
        content: |
          LOKI_OPTS='{{ loki_options }}'
          LOKI_DATA={{ loki_data_dir }}
          LOKI_RETENTION_PERIOD={{ loki_retention }}


#------------------------------------------------------------------------------
# Launch
#------------------------------------------------------------------------------
- name: launch loki
  tags: loki_launch
  when: loki_enabled|bool
  block:

    - name: launch loki systemd service
      systemd: name=loki state=restarted enabled=yes daemon_reload=yes

    - name: wait for loki service online
      wait_for: host=127.0.0.1 port=3100 state=started timeout=20

...
