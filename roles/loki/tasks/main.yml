#------------------------------------------------------------------------------
# Install
#------------------------------------------------------------------------------
- name: Install loki via yum
  tags: loki_install
  package: name=loki state=present

#------------------------------------------------------------------------------
# Cleanup
#------------------------------------------------------------------------------
- name: Cleanup loki
  tags: loki_clean
  when: loki_clean|bool
  file: path={{ loki_data_dir }} state=absent owner=prometheus

#------------------------------------------------------------------------------
# Config
#------------------------------------------------------------------------------
- name: Config loki
  tags: loki_config
  block:

    - name: Render loki config
      template: src=loki.yml.j2 dest=/etc/loki.yml owner=prometheus

    - name: Copy loki systemd service
      copy:
        src: loki.service
        dest: /usr/lib/systemd/system/loki.service

#------------------------------------------------------------------------------
# Launch
#------------------------------------------------------------------------------
- name: Launch loki
  tags: loki_launch
  block:
    - name: Launch Loki
      systemd: name=loki state=restarted enabled=yes daemon_reload=yes

    - name: Wait for loki online
      wait_for: host=127.0.0.1 port=3100 state=started timeout=20

...
