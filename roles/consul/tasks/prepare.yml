---
#------------------------------------------------------------------------------
# Check Consul
#------------------------------------------------------------------------------
- name: check consul exists
  tags: consul_check
  block:

    #--------------------------------------------------------------------------
    # check consul exists
    #--------------------------------------------------------------------------
    - name: check consul exists
      command: 'ss -tp state listening sport = :8500'
      register: check_consul_port_result
    - name: set consul exists flag
      connection: local
      set_fact:
        consul_exists: "{{ 'consul' in check_consul_port_result.stdout }}"

    #--------------------------------------------------------------------------
    # abort if consul already exists
    #--------------------------------------------------------------------------
    # when any running instance exists, abort play in two cases:
    # 1. dcs_safeguard = true          (global flag to prevent accidentally purge)
    # 2. dcs_clean = true
    - name: ABORT due to consul exists
      connection: local
      any_errors_fatal: true
      when: consul_exists and (dcs_safeguard or not dcs_clean)
      fail: msg="Abort because consul instance {{ inventory_hostname }} is running, use dcs_clean=true"


#------------------------------------------------------------------------------
# Purge Consul
#------------------------------------------------------------------------------
- name: purge consul
  tags: consul_clean
  block:

    #--------------------------------------------------------------------------
    # purge dcs
    #--------------------------------------------------------------------------
    # dangerous: (it will remove consul data!)
    - name: WARNING, PURGE CONSUL INSTANCE!
      # connection: local, leave a chance for human intervention
      when: not dcs_safeguard and consul_exists and dcs_clean # DANGEROUS!
      debug:
        msg: "[DANGEROUS] RUNNING CONSUL INSTANCE {{ inventory_hostname }} WILL BE PURGED!"

    - name: remove consul
      ignore_errors: yes
      shell: |
        # try graceful shutdown first
        if ps -u consul -o command | grep -q 'consul agent' ; then
            /usr/bin/consul leave
            systemctl stop consul
        fi
        
        # kill if still exists
        if ps -u consul -o command | grep -q 'consul agent' ; then
            sleep 2
            ps -u consul -o pid:1,command | grep 'consul agent' | awk '{print $1}' | xargs kill
        fi
        
        # kill -9 if not killed 
        if ps -u consul -o command | grep -q 'consul agent' ; then
            sleep 5
            ps -u consul -o pid:1,command | grep 'consul agent' | awk '{print $1}' | xargs kill -9
        fi
        
        # guaranteed success
        rm -rf /etc/consul.d
        rm -rf /var/lib/consul/*
        rm -rf "{{ consul_data_dir }}"
        rm -rf /etc/systemd/system/consul.service.d
        rm -f /etc/profile.d/consul.sh
        exit 0


#------------------------------------------------------------------------------
# prepare consul user
#------------------------------------------------------------------------------
- name: add consul user to dcs group
  tags: consul_user
  user: name=consul home=/var/lib/consul groups=dcs append=yes


#------------------------------------------------------------------------------
# prepare consul dir
#------------------------------------------------------------------------------
- name: create consul directories
  tags: consul_dir
  block:

    - name: create consul config dir
      file: path={{ item }} state=directory owner=consul group=dcs mode=0750
      with_items:
        - /etc/consul.d
        - /var/lib/consul
        - /etc/consul.d/ssl

    - name: create consul data dir
      file: path="{{ consul_data_dir }}" state=directory owner=consul group=dcs mode=0700

#------------------------------------------------------------------------------
# consul environment
#------------------------------------------------------------------------------
- name: write consul environment profile
  tags: consul_env
  copy:
    dest: /etc/profile.d/consul.sh
    mode: 0644
    content: |
      #!/bin/bash
      {% if dcs_ssl_enabled|bool %}
      export CONSUL_HTTP_SSL=true
      {% endif %}
      
      # dcs alias
      alias cst="systemctl status consul"
      alias cm="consul members"
      alias cnode="consul catalog nodes -detailed"
      alias csvc="consul catalog services --tags"
...