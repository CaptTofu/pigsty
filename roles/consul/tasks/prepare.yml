---
#------------------------------------------------------------------------------
# Check consul
#------------------------------------------------------------------------------
- name: Check existing consul
  tags: consul_check
  block:

    #--------------------------------------------------------------------------
    # check consul exists
    #--------------------------------------------------------------------------
    - name: Check for existing consul
      command: 'ss -tp state listening sport = :8500'
      register: check_consul_port_result

    - name: Consul exists flag fact set
      connection: local
      set_fact:
        consul_exists: "{{ 'consul' in check_consul_port_result.stdout }}"

    #--------------------------------------------------------------------------
    # abort if consul already exists
    #--------------------------------------------------------------------------
    # when any running instance exists, abort play in two cases:
    # 1. dcs_safeguard = true          (global flag to prevent accidentally purge)
    # 2. dcs_clean = true
    - name: Abort due to existing consul instance
      connection: local
      any_errors_fatal: true
      when: consul_exists and (dcs_safeguard or not dcs_clean)
      fail: msg="Abort because consul instance {{ inventory_hostname }} is running, use dcs_clean=true"


#------------------------------------------------------------------------------
# Clean consul
#------------------------------------------------------------------------------
- name: Clean existing consul
  tags: consul_clean
  block:
    #--------------------------------------------------------------------------
    # purge dcs
    #--------------------------------------------------------------------------
    # dangerous: (it will remove consul data!)
    - name: Clean existing consul instance
      # connection: local, leave a chance for human intervention
      when: not dcs_safeguard and consul_exists and dcs_clean # DANGEROUS!
      debug:
        msg: "[DANGEROUS] RUNNING CONSUL INSTANCE {{ inventory_hostname }} WILL BE PURGED!"

    - name: Stop any running consul instance
      ignore_errors: yes
      shell: |
        # try graceful shutdown first
        if ps -u consul -o command | grep -q 'consul agent' ; then
            /usr/bin/consul leave
            systemctl stop consul
        fi
        
        # kill if still exists
        if ps -u consul -o command | grep -q 'consul agent' ; then
            sleep 2
            ps -u consul -o pid:1,command | grep 'consul agent' | awk '{print $1}' | xargs kill
        fi
        
        # kill -9 if not killed 
        if ps -u consul -o command | grep -q 'consul agent' ; then
            sleep 5
            ps -u consul -o pid:1,command | grep 'consul agent' | awk '{print $1}' | xargs kill -9
        fi
        
        # guaranteed success
        rm -rf /etc/consul.d
        rm -rf /var/lib/consul/*
        rm -rf "{{ consul_data_dir }}"
        rm -rf /etc/systemd/system/consul.service.d
        rm -f /etc/profile.d/consul.sh
        exit 0


#------------------------------------------------------------------------------
# prepare consul user
#------------------------------------------------------------------------------
- name: Add consul user to dcs group
  tags: consul_user
  user: name=consul home=/var/lib/consul groups=dcs append=yes


#------------------------------------------------------------------------------
# prepare consul dir
#------------------------------------------------------------------------------
- name: Create consul dir
  tags: consul_dir
  file: path={{ item }} state=directory owner=consul group=consul mode=0750
  with_items:
    - /etc/consul.d
    - /var/lib/consul
    - "{{ consul_data_dir }}"


#------------------------------------------------------------------------------
# prepare consul_alias
#------------------------------------------------------------------------------
# write consul env & cert to all nodes
- name: Write consul env profile
  tags: consul_alias
  when: dcs_ssl_enabled|bool
  copy:
    dest: /etc/profile.d/consul.sh
    mode: 0644
    content: |
      export CONSUL_HTTP_SSL=true

...