---
#------------------------------------------------------------------------------
# Launch consul server first
#------------------------------------------------------------------------------
- name: setup consul server
  tags: consul_server
  when: inventory_hostname in dcs_servers.values()
  throttle: 1    # NOTE: SETUP SERVER ONE BY ONE
  block:

    # launch consul server
    - name: launch consul server
      systemd: name=consul state=restarted enabled=yes daemon_reload=yes

    # wait consul online
    - name: wait for consul server online
      wait_for: host=127.0.0.1 port=8500 state=started timeout=30

#------------------------------------------------------------------------------
# Launch consul agent
#------------------------------------------------------------------------------
- name: setup consul agent
  tags: consul_agent
  when: inventory_hostname not in dcs_servers.values()
  block:

    # launch consul agent
    - name: launch consul agent service
      systemd: name=consul state=restarted enabled=yes daemon_reload=yes

    # wait consul agent online
    - name: wait for consul agent online
      wait_for: host=127.0.0.1 port=8500 state=started timeout=30

...