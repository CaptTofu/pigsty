---
#--------------------------------------------------------------#
# Config PgBackrest Repo                     [pgbackrest_config]
#--------------------------------------------------------------#
- name: config pgbackrest
  tags: pgbackrest_config
  block:

    - name: remove unused pgbackrest.conf file
      file: path=/etc/pgbackrest.conf state=absent

    - name: render pgbackrest config
      template: src=pgbackrest.conf.j2 dest=/etc/pgbackrest/pgbackrest.conf owner=postgres group=postgres mode=0600


#--------------------------------------------------------------#
# Config PgBackrest Repo                       [pgbackrest_init]
#--------------------------------------------------------------#
- name: config pgbackrest
  tags: pgbackrest_init
  block:

    - name: create pgbackrest stanza
      become: yes
      become_user: "{{ pg_dbsu }}"
      shell: /usr/bin/pgbackrest --stanza={{ pg_cluster }} --no-online stanza-create

    # if /etc/pgbackrest/initial.done exists, we will skip this task
    - name: create an empty full backup
      when: pg_role == 'primary' and pg_upstream is not defined
      ignore_errors: yes
      become: yes
      become_user: "{{ pg_dbsu }}"
      shell: |
        if [[ -f /etc/pgbackrest/initial.done ]]; then
            echo "initial backup already done"
        else
            /usr/bin/pgbackrest --stanza={{ pg_cluster }} backup
            date > /etc/pgbackrest/initial.done  
        fi

...