---
#--------------------------------------------------------------#
# Install PostgreSQL Packages                           [pg_pkg]
#--------------------------------------------------------------#
- name: install postgres packages
  become: yes
  tags: pg_pkg
  block:

    # install postgres basic packages
    - name: install postgres packages
      environment: "{{ proxy_env | default({}) }}"
      package: name={{ item | replace('${pg_version}', pg_version|string)|replace(' ',',') }}
      with_items: "{{ pg_packages }}"

    # install postgres extensions
    - name: install postgres extensions
      tags: pg_extension
      environment: "{{ proxy_env | default({}) }}"
      package: name={{ item | replace('${pg_version}', pg_version|string)|replace(' ',',') }}
      with_items: "{{ pg_extensions }}"

    # fix run dir ownership
    - name: own /var/run/postgresql with dbsu
      file: path=/var/run/postgresql state=directory owner={{ pg_dbsu }} group=postgres

    # fix rpm trash and unused service file
    - name: remove unnecessary postgres files
      ignore_errors: true
      shell: |
        rm -rf /usr/lib/systemd/system/postgresql-{{ pg_version }}.service # rhel
        rm -rf /lib/systemd/system/postgresql.service  # debian
        rm -rf '/%{_sysconfigdir}'   # introduced by patroni rpm
        rm -rf '/%{_logdir}'         # remove these if patroni rpm fixed
        if [ ! -f /usr/bin/patroni ] && [ -f /usr/local/bin/patroni ]; then
          ln -s /usr/local/bin/patroni /usr/bin/patroni;
        fi;
        systemctl daemon-reload;
        /bin/true;


#--------------------------------------------------------------#
# Setup bin path                                       [pg_path]
#--------------------------------------------------------------#
# soft link pgsql bin dir to specific pgsql binary version
# RHEL  : /usr/pgsql-{{ pg_version }}
# Debian: /usr/lib/postgresql/{{ pg_version }}
- name: link pg bin dir to current version
  tags: pg_path
  file: src="{{ pg_home_dir }}" dest={{ pg_bin_dir | dirname }} state=link
  vars: { pg_home_dir : "{% if os_package is defined and os_package == 'deb' %}/usr/lib/postgresql/{{ pg_version }}{% else %}/usr/pgsql-{{ pg_version }}{% endif %}" }


#--------------------------------------------------------------#
# Setup pgsql profile                                   [pg_env]
#--------------------------------------------------------------#
# add /usr/pgsql/bin/ to PATH environment variable
- name: add pgsql path to system profile
  tags: pg_env
  copy:
    dest: /etc/profile.d/pgsql.sh
    mode: 0755
    content: |
      export PATH="{{ pg_bin_dir }}:/pg/bin:$PATH"
      export PGHOME={{ pg_bin_dir | dirname }}
      export PGDATA={{ pg_data }}
...