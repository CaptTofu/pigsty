---
#------------------------------------------------------------------------------
# install promtail                                           [promtail_install]
#------------------------------------------------------------------------------
- name: install promtail via yum
  tags: promtail_install
  ignore_errors: "{{ not promtail_enabled|bool }}"  # ignore errors if not enabled
  package: name=promtail state=present

#------------------------------------------------------------------------------
# cleanup promtail                                             [promtail_clean]
#------------------------------------------------------------------------------
- name: remove promtail positions
  tags: promtail_clean
  when: promtail_clean|bool and promtail_enabled|bool
  file: path={{ promtail_positions }} state=absent

#------------------------------------------------------------------------------
# config promtail                                             [promtail_config]
#------------------------------------------------------------------------------
- name: config promtail
  tags: promtail_config
  block:

    - name: remove promtail /etc/systemd service
      file: dest=/etc/systemd/system/promtail.service state=absent

    - name: create promtail systemd service
      copy: src=promtail.service dest=/usr/lib/systemd/system/promtail.service

    - name: render /etc/promtail.yml config
      template: src=promtail.yml.j2 dest=/etc/promtail.yml

#------------------------------------------------------------------------------
# launch promtail                                             [promtail_launch]
#------------------------------------------------------------------------------
- name: Launch promtail
  tags: promtail_launch
  when: promtail_enabled|bool
  block:
    - name: launch promtail systemd service
      systemd: name=promtail state=restarted enabled=yes daemon_reload=yes

    - name: wait for promtail online
      wait_for: host=127.0.0.1 port={{ promtail_port }} state=started timeout=20

...