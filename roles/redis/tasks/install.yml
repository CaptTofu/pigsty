#------------------------------------------------------------------------------
# install by yourself
#------------------------------------------------------------------------------
# if exporter_install = none (default)
# then you have to install via node_packages (redis,node_exporter,redis_exporter)
# or just manually install them


#------------------------------------------------------------------------------
# install via yum
# to install redis/node_exporter/redis_exporter via yum
# you have to make sure either current repo have corresponding packages
# (which is included in meta:/www/pigsty by default, and installed to node in role `node`)
# or add extra repo file via `exporter_repo_url`
#------------------------------------------------------------------------------
- name: Install redis via yum
  tags: [ redis_install, redis_install_yum ]
  when: exporter_install == 'yum'
  block:

    #------------------------------------------------------------------------------
    # if exporter_repo_url is set, add that url repo to /etc/yum.repos.d first
    #------------------------------------------------------------------------------
    - name: Install exporter yum repo
      when: exporter_repo_url != ''
      get_url:
        url: "{{ exporter_repo_url }}"
        dest: /etc/yum.repos.d/{{ item | basename }}

    #------------------------------------------------------------------------------
    # if exporter_repo_url is set, add that url repo to /etc/yum.repos.d first
    #------------------------------------------------------------------------------
    - name: Install node_exporter and pg_exporter
      package: name={{ item }} state=present
      with_items:
        - redis
        - node_exporter
        - redis_exporter


#------------------------------------------------------------------------------
# install via copy binary
# these binary MUST be put into files/bin directory before running
# you can download that binary with files/get_redis
# node_exporter & redis_exporter should be put into there too
#------------------------------------------------------------------------------
- name: Copy node_exporter and pg_exporter
  tags: [ redis_install, redis_install_binary ]
  when: exporter_install == 'binary'
  block:
    - name: Copy redis binaries
      when: exporter_install == 'binary'

      copy: src=bin/{{ item }} dest=/usr/bin/{{ item }} owner=root mode=0755
      ignore_errors: true
      with_items:
        - redis-server
        - redis-server
        - redis-cli
        - redis-sentinel
        - redis-check-rdb
        - redis-check-aof
        - redis-benchmark
        - node_exporter
        - redis_exporter

    - name: Copy redis shutdown script
      when: exporter_install == 'binary'
      tags: [ redis_install, redis_install_binary ]
      copy: src=redis-shutdown dest=/usr/libexec/redis-shutdown owner=root mode=0755





