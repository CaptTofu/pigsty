---
# WARNING: you have to run

#------------------------------------------------------------------------------
# Config etcd cert
#------------------------------------------------------------------------------
- name: generate etcd cert for servers
  tags: etcd_cert
  when: dcs_ssl_enabled|bool and inventory_hostname in dcs_servers.values()
  delegate_to: "{{ meta_ip }}"
  block:

    - name: generate etcd private key
      openssl_privatekey:
        path: "/etc/pki/CA/etcd-{{ dcs_nodename }}.key"
        mode: 0600

    - name: generate etcd signing request
      openssl_csr:
        path: "/etc/pki/CA/etcd-{{ dcs_nodename }}.csr"
        privatekey_path: "/etc/pki/CA/etcd-{{ dcs_nodename }}.key"
        common_name: "{{ dcs_nodename }}"
        subject_alt_name:
          - DNS:localhost
          - "DNS:{{ dcs_nodename }}"
          - IP:127.0.0.1
          - "IP:{{ inventory_hostname }}"

    - name: issue etcd server certificate
      openssl_certificate:
        path: "/etc/pki/CA/etcd-{{ dcs_nodename }}.crt"
        csr_path: "/etc/pki/CA/etcd-{{ dcs_nodename }}.csr"
        ownca_path: /etc/pki/ca.crt
        ownca_privatekey_path: /etc/pki/ca.key
        provider: ownca
        selfsigned_not_after: "+{{ cert_validity }}"
        mode: 0644

    # fetch etcd certs from meta node
    - name: create local files/pki/ dir for etcd
      delegate_to: localhost
      become: no
      file: path="files/pki/{{ inventory_hostname }}" state=directory
    - name: fetch etcd cert and key to local
      fetch: src={{ item.src }} dest={{ item.dest }} flat=yes
      with_items:
        - { src: "/etc/pki/CA/etcd-{{ dcs_nodename }}.crt"   , dest: "files/pki/{{ inventory_hostname }}/etcd.crt" }
        - { src: "/etc/pki/CA/etcd-{{ dcs_nodename }}.key" , dest: "files/pki/{{ inventory_hostname }}/etcd.key" }


- name: copy etcd certs
  tags: [ etcd_cert, etcd_cert_copy ]
  when: dcs_ssl_enabled|bool and inventory_hostname in dcs_servers.values()
  block:
    - name: copy etcd ssl cert
      copy: src="files/pki/{{ inventory_hostname }}/etcd.crt" dest="/etc/etcd/etcd.crt" owner=etcd group=dcs mode=0644
    - name: copy etcd ssl key
      copy: src="files/pki/{{ inventory_hostname }}/etcd.key" dest="/etc/etcd/etcd.key" owner=etcd group=dcs mode=0600


#------------------------------------------------------------------------------
# Config etcd server
#------------------------------------------------------------------------------
- name: setup etcd server
  tags: etcd_config
  when: inventory_hostname in dcs_servers.values()
  block:

    # config etcd
    - name: copy etcd server service unit
      template: src=etcd.service.j2 dest=/usr/lib/systemd/system/etcd.service

    # only server need config
    - name: copy /etc/etcd/etcd.conf
      template: src=etcd.conf.j2 dest=/etc/etcd/etcd.conf owner=etcd mode=0644

...