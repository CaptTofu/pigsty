---
# https://www.digitalocean.com/community/tutorials/how-to-set-up-and-secure-an-etcd-cluster-with-ansible-on-ubuntu-18-04#step-13-copying-private-keys-and-certificates

#------------------------------------------------------------------------------
# 1. Prepare ETCD Env: Check & Cleanup & Dir & User
#------------------------------------------------------------------------------
# tasks: etcd_check , etcd_clean, etcd_user, etcd_dir, etcd_alias
# abort if dcs_safeguard set to ture and etcd is running
- import_tasks: prepare.yml
  tags: etcd_prepare
  when: inventory_hostname in dcs_servers.values()

#------------------------------------------------------------------------------
# 2. Config ETCD
#------------------------------------------------------------------------------
- import_tasks: config.yml
  tags: etcd_config
  vars:
    dcs_nodename: "{% if inventory_hostname in dcs_servers.values() %}{{ (dcs_servers|dict2items|items2dict(key_name='value', value_name='key'))[inventory_hostname] }}{% else %}{{ nodename }}{% endif %}"
  when: inventory_hostname in dcs_servers.values()

#------------------------------------------------------------------------------
# 3. Launch Etcd Server
#------------------------------------------------------------------------------
- import_tasks: launch.yml
  tags: etcd_launch
  when: inventory_hostname in dcs_servers.values()

#------------------------------------------------------------------------------
# ETCD Client (will be executed on all meta nodes)
#------------------------------------------------------------------------------
- name: write etcd environment profile
  tags: etcd_client
  when: meta_node|bool
  copy:
    dest: /etc/profile.d/etcd.sh
    mode: 0644
    content: |
      export ETCDCTL_API=2
      {% if dcs_ssl_enabled is defined and dcs_ssl_enabled|bool %}
      export ETCDCTL_ENDPOINTS="{% for k,v in dcs_servers.items() %}{% if not loop.first %},{% endif %}https://{{ v }}:2379{% endfor %}"
      {% else %}
      export ETCDCTL_ENDPOINTS="{% for k,v in dcs_servers.items() %}{% if not loop.first %},{% endif %}http://{{ v }}:2379{% endfor %}"
      {% endif %}
      ETCDPTS="--ca-file=/etc/pki/ca.crt --cert-file=/etc/pki/meta.crt --key-file=/etc/pki/meta.key"

      alias e="etcdctl --ca-file=/etc/pki/ca.crt --cert-file=/etc/pki/meta.crt --key-file=/etc/pki/meta.key"
      alias est="systemctl status etcd"
      alias em="etcdctl --ca-file=/etc/pki/ca.crt --cert-file=/etc/pki/meta.crt --key-file=/etc/pki/meta.key member list"
      alias ech="etcdctl --ca-file=/etc/pki/ca.crt --cert-file=/etc/pki/meta.crt --key-file=/etc/pki/meta.key cluster-health"

...