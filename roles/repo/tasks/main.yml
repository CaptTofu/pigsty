#!/usr/bin/env ansible-playbook
---
#==============================================================#
# Init a local yum repo powered by a local nginx web server
# all necessary rpm packages are downloaded to accelerate
# cluster initialization, or in case that target machine does
# not have internet access.
#
# RPM packages are downloaded to {{ nginx_home }}/{{ repo_name }}.
# And it will skip download if all packages already exists
#
# Local yum repo url:  http://{{ repo_address }}/{{ repo_name }}/
#==============================================================#


# call with :   ./infra.yml -t repo_url_pkg      # redownload weburl pacakges
# call with :   ./infra.yml -t repo_boot_pkg     # install bootstrap pacakges
# call with :   ./infra.yml -t repo_rpm_pkg      # download repo rpm pacakges
# call with :   ./infra.yml -t repo_create       # create yum repo
# build without check: ./infra.yml -t repo_build -e repo_url_packages=[] -e repo_packages=[]

# ./infra.yml -t repo                 # init repo
# ./infra.yml -t repo_prepare         # use existing repo if exists
# ./infra.yml -t repo_build           # (re)build local repo
# ./infra.yml -t repo_nginx           # setup nginx server for repo
# ./infra.yml -t repo_create          # recreate repo
# ./infra.yml -t repo_upstream        # add upstream repo file
# ./infra.yml -t repo_build   -e repo_url_packages=[]    # build & skip url download
# ./infra.yml -t repo_build   -e repo_packages=[]        # build & skip rpm download
# ./infra.yml -t repo_build   -e repo_packages=[] -e repo_url_packages=[]  # skip download
# ./infra.yml -t repo_url_pkg -e repo_url_packages=[https://github.com/dalibo/pev2/releases/download/v1.5.0/index.html]
- # ./infra.yml -t repo_pkg   -e repo_packages=[xxxx]

#--------------------------------------------------------------#
# 1. Check whether repo exists?
#--------------------------------------------------------------#
# check flag file /www/pigsty/repo_complete existence
- name: Check local repo exists
  tags: repo_prepare
  block:
    # create repo directory
    - name: Create local repo dir
      tags: repo_dir
      file: path={{ nginx_home }}/{{ repo_name }} state=directory mode=0755
    # set repo_exists = true if local repo already exists
    - name: Check repo pkgs cache exists
      stat: path={{ nginx_home }}/{{ repo_name }}/repo_complete
      register: repo_cache
    - name: Set fact whether repo_exists
      connection: local
      set_fact:
        repo_exists: "{{ repo_cache.stat.exists }}"

#--------------------------------------------------------------#
# 2. Use local repo (IF REPO EXISTS)
#--------------------------------------------------------------#
# if local yum cache exists, use it directly
- name: Setup existing local repo
  tags: repo_prepare
  when: repo_exists|bool
  shell: |
    mkdir -p /etc/yum.repos.d/backup/
    mv -f /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ || /bin/true
    cat > /etc/yum.repos.d/{{ repo_name }}-local.repo <<-'EOF'
    [{{ repo_name }}-local]
    name={{ repo_name }}-local $releasever - $basearch
    baseurl=file://{{ nginx_home }}/{{ repo_name }}/
    enabled=1
    gpgcheck=0
    {% if el_ver|int >= 8 %}
    module_hotfixes=1
    {% endif %}
    EOF
    yum clean all;
    yum makecache;
    yum install -y wget nginx sshpass createrepo_c yum-utils;


#--------------------------------------------------------------#
# 3. Build repo (IF REPO NOT EXISTS)
#--------------------------------------------------------------#
- name: Build local yum repo
  tags: repo_build
  when: not repo_exists|bool
  block:

    #--------------------------------------------------------------#
    # 3.1 Get el releasever : (7,8,9)                      [repo_os]
    #--------------------------------------------------------------#
    - name: Gather el release version
      tags: [ always, repo_os ]
      shell: rpm -q --qf "%{VERSION}" $(rpm -q --whatprovides redhat-release) | grep -o '^[^.]\+'
      register: releasever_result
    - name: Set el release version
      tags: [ always, repo_os ]
      connection: local
      set_fact: { el_ver: "{{ releasever_result.stdout }}" }

    #--------------------------------------------------------------#
    # 3.2   Remove existing upstream repo files        [repo_remove]
    #--------------------------------------------------------------#
    - name: Backup & remove existing repos
      tags: [ repo_upstream, repo_remove ]
      when: repo_remove|bool
      shell:
        warn: no
        cmd: |
          mkdir -p /etc/yum.repos.d/backup/
          mv -f /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ || /bin/true

    #--------------------------------------------------------------#
    # 3.3  Add required upstream repo files               [repo_add]
    #--------------------------------------------------------------#
    - name: Add required upstream repos
      tags: [ repo_upstream , repo_add ]
      copy:
        dest: /etc/yum.repos.d/{{ item.name }}.repo
        content: |
          [{{ item.name }}]
          name = {{ item.description }} $releasever - $basearch
          {% if region in item.baseurl and item.baseurl[region] != '' %}
          baseurl = {{ item.baseurl[region] | regex_replace('\$releasever', el_ver|string )  }}
          {% else %}
          {% if item.name == 'prometheus' and el_ver|int >= 8 %}
          baseurl = {{ item.baseurl.default | regex_replace('\$releasever', '8' )  }}
          {% else %}
          baseurl = {{ item.baseurl.default | regex_replace('\$releasever', el_ver|string )  }}
          {% endif %}
          {% endif %}
          gpgcheck = 0
          enabled = 1
          {% if el_ver|int >= 8 %}
          module_hotfixes=1
          {% endif %}
      when: el_ver|int in item.releases
      with_items: "{{ repo_upstream }}"

    #--------------------------------------------------------------#
    # 3.4  Download url packages                      [repo_url_pkg]
    #--------------------------------------------------------------#
    # download packages directly via url (replace ${releasever} to 7|8|9)
    - name: Download web url packages
      tags: repo_url_pkg
      ignore_errors: true
      environment: "{{ proxy_env }}"
      get_url: dest={{ nginx_home }}/{{ repo_name }}/ url={{ item | regex_replace('\${releasever}', el_ver|string) | regex_replace('\${arch}', arch|string ) }}
      with_items: "{{ repo_url_packages }}"

    #--------------------------------------------------------------#
    # 3.5 Make repo cache                           [repo_makecache]
    #--------------------------------------------------------------#
    # this usually takes 1~2 minutes, according to your network condition and region & mirrors
    - name: Clean all and make cache
      tags: repo_makecache
      environment: "{{ proxy_env }}"
      shell: |
        yum clean all;
        yum makecache;
        {% if el_ver|int >= 8 %}
        dnf module disable -y php nginx postgresql;
        {% endif %}
        /bin/true

    #--------------------------------------------------------------#
    # 3.6  Download bootstrap packages               [repo_boot_pkg]
    #--------------------------------------------------------------#
    - name: Install repo bootstrap packages
      tags: repo_boot_pkg
      yum: name="createrepo_c,yum-utils{% if el_ver|int >= 8 %},modulemd-tools{% endif %}" state=present

    #--------------------------------------------------------------#
    # 3.7 Download rpm Packages                           [repo_pkg]
    #--------------------------------------------------------------#
    - name: Download rpm packages and their deps
      tags: repo_pkg
      environment: "{{ proxy_env }}"
      shell:
        cmd: |
          {% if el_ver|int >= 8 %}
          repotrack --arch x86_64,noarch {{ item }};
          {% else %}
          repotrack {{ item }}
          {% endif %}
        chdir: "{{ nginx_home }}/{{ repo_name }}"
      with_items: "{{ repo_packages }}"

    #--------------------------------------------------------------#
    # 3.8 Create repo                                  [repo_create]
    #--------------------------------------------------------------#
    # create local yum repo
    - name: Create local repo
      tags: repo_create
      shell:
        cmd: |
          #!/bin/bash
          rm -f *.i686.rpm   # remove i686 packages
          createrepo_c {{ nginx_home }}/{{ repo_name }}
          {% if el_ver|int >= 8 %}
          repo2module -s stable . modules.yaml
          modifyrepo_c --mdtype=modules modules.yaml repodata/              
          {% endif %}
          cd {{ nginx_home }}/{{ repo_name }}
          md5sum *.rpm > {{ nginx_home }}/{{ repo_name }}/repo_complete || /bin/true
        chdir: "{{ nginx_home }}/{{ repo_name }}"

    #--------------------------------------------------------------#
    # 3.9 Use built repo                                  [repo_use]
    #--------------------------------------------------------------#
    - name: Install local repo file
      tags: repo_use
      shell: |
        mkdir -p /etc/yum.repos.d/backup/
        mv -f /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ || /bin/true
        cat > /etc/yum.repos.d/{{ repo_name }}-local.repo <<-'EOF'
        [{{ repo_name }}-local]
        name={{ repo_name }}-local $releasever - $basearch
        baseurl=file://{{ nginx_home }}/{{ repo_name }}/
        enabled=1
        gpgcheck=0
        {% if el_ver|int >= 8 %}
        module_hotfixes=1
        {% endif %}
        EOF
        yum clean all;
        yum makecache;
        yum install -y wget sshpass createrepo_c yum-utils nginx;

#--------------------------------------------------------------#
# 8. Launch Nginx
#--------------------------------------------------------------#
# launch nginx server for yum repo
- name: Launch repo nginx server
  tags: repo_nginx
  block:

    # make sure nginx installed
    - name: Make sure nginx installed
      package: name=nginx state=present

    # copy repo nginx config & content
    - name: Render repo nginx server files
      template: src={{ item.src }} dest={{ item.dest }} mode=0644
      with_items:
        - {src: nginx.conf.j2,    dest: /etc/nginx/nginx.conf}
        - {src: default.conf.j2,  dest: /etc/nginx/conf.d/default.conf}
        - {src: index.html.j2,    dest: "{{ nginx_home }}/index.html" }
        - {src: local.repo.j2,    dest: "{{ nginx_home }}/{{ repo_name }}.repo"}

    # setup selinux & firewalld for nginx
    - name: Disable selinux for repo server
      selinux: state=disabled
    #- name: Allow nginx port traffic
    #  tags: repo_fire
    #  ignore_errors: true
    #  firewalld:
    #    port: "{{ nginx_port }}/tcp"
    #    permanent: true
    #    immediate: true
    #    state: enabled
    #- name: Allow ssh/http/https traffics
    #  tags: repo_fire
    #  ignore_errors: true
    #  firewalld:
    #    service: "{{ item }}"
    #    permanent: true
    #    immediate: true
    #    state: enabled
    #  with_items: [ ssh , http , https ]

    # launch nginx with systemctl and wait for port 80 online
    - name: Launch repo nginx server
      systemd: name=nginx state=restarted enabled=yes daemon_reload=yes

    - name: Waits repo server online
      wait_for: host=127.0.0.1 port={{ nginx_port }} state=started
...


