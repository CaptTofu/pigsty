---
#------------------------------------------------------------------------------
# Register Node to Prometheus
#------------------------------------------------------------------------------
# /etc/prometheus/targets/nodes/{{ ip }}.yml
- name: Register node exporter as prometheus target
  tags: [ node_register, register_prometheus ]
  delegate_to: '{{ item }}'
  with_items: '{{ groups["meta"] }}'
  copy:
    dest: /etc/prometheus/targets/nodes/{{ inventory_hostname }}.yml
    content: |
      # {{ inventory_hostname }}
      - labels: { ip: {{ inventory_hostname }} , ins: {{ nodename }} , cls: {{ node_cluster|default('nodes') }} }
        targets: 
          {% if node_exporter_enabled|bool %}- {{ inventory_hostname }}:{{ node_exporter_port }}{% endif %}
      
          {% if docker_enabled|bool %}- {{ inventory_hostname }}:9323{% endif %}
          

...