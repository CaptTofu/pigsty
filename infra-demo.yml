#!/usr/bin/env ansible-playbook
---
#==============================================================#
# File      :   infra-demo.yml
# Ctime     :   2021-01-19
# Mtime     :   2022-01-11
# Desc      :   init demo on all nodes (one-pass bootstrap)
# Path      :   infra-demo.yml
# Copyright (C) 2018-2022 Ruohang Feng (rh@vonng.com)
#==============================================================#

#---------------------------------------------------------------
# Notice
#---------------------------------------------------------------
# This is a special playbook that interleave infra.yml & pgsql.yml
# It is used for 4-node demo, or in case that there are multiple
# meta nodes also reused as common database nodes.
#
# to init multiple meta nodes, add their ip address to pigsty.yml
#   all.children.meta.hosts
#
# if offline installation packages is used, you can also copy them to
#   copy /www/pigsty to all meta nodes before run ./demo.yml
#
#---------------------------------------------------------------


#---------------------------------------------------------------
- name: Init Repo on Meta Nodes
  become: yes
  hosts: meta
  gather_facts: no
  tags: repos
  roles:

    - role: environ         # init postgres pgbouncer patroni
      tags: environ

    - role: repo            # init local yum repo on meta node
      tags: repo
      when: repo_enabled|bool

#---------------------------------------------------------------
- name: Init All Nodes with DCS
  become: yes
  hosts: all
  tags: nodes
  gather_facts: no
  roles:

    - role: node            # init meta node
      tags: node

    - role: consul          # init dcs:consul (servers)
      tags: dcs

#---------------------------------------------------------------
- name: Init Infrastructure on Meta Nodes
  become: yes
  hosts: meta
  tags: meta
  gather_facts: no
  roles:
    - role: ca              # init ca-infrastructure
      tags: ca

    - role: nameserver      # init dns nameserver
      tags: nameserver

    - role: nginx           # init nginx
      tags: nginx

    - role: prometheus      # init prometheus
      tags: prometheus

    - role: grafana         # init grafana
      tags: grafana

    #---------------------------------------------------------------
    # extra infra services
    #---------------------------------------------------------------
    - role: jupyter         # init jupyter lab
      tags: jupyter
      ignore_errors: true

    - role: pgweb           # init pgweb console
      tags: pgweb
      ignore_errors: true

    - role: loki            # init pgweb console
      tags: loki
      ignore_errors: true


#---------------------------------------------------------------
- name: Init All Postgres Instances
  become: yes
  hosts: all
  gather_facts: no
  tags: pgsql
  roles:

    - role: node_exporter   # init node exporter
      tags: node_exporter

    - role: postgres        # init postgres pgbouncer patroni
      tags: postgres

    - role: pg_exporter     # init monitor exporters
      tags: pg_exporter

    - role: service         # init service , lb , vip
      tags: service

    - role: register        # register cluster/instance to infra
      tags: register

#---------------------------------------------------------------
...
